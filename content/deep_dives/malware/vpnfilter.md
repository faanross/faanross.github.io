---
showTableOfContents: true
title: "Deconstructing the VPNFilter C2 Protocol"
type: "page"
---
## Introduction

[VPNFilter](https://malpedia.caad.fkie.fraunhofer.de/details/elf.vpnfilter) is not a singular piece of malware but a sophisticated, multi-stage, modular framework designed for espionage, 
data theft, network manipulation, and potentially large-scale destructive attacks. Attributed to the state-sponsored 
Sofacy Group (also known as [APT28](https://attack.mitre.org/groups/G0007/) or Fancy Bear), VPNFilter has infected an estimated 500,000 Small Office/Home Office (SOHO) 
routers and Network-Attached Storage (NAS) devices across at least 54 countries. 

Its capabilities included harvesting website credentials, monitoring sensitive SCADA protocols used in 
Industrial Control Systems (ICS), injecting malicious content into network traffic, and deploying a 
destructive payload capable of rendering devices permanently inoperable.

## Multi-Stage Network Architecture

VPNFilter operates in three distinct stages, each with a specific role in the attack lifecycle.

### Stage 1 (Persistent Loader)
The primary objective of Stage 1 is to establish a persistent foothold on the compromised device that can survive a reboot. This critical feature distinguishes VPNFilter from more common, ephemeral IoT malware like Mirai, which is wiped from memory upon a device restart.

The Stage 1 component achieves persistence by modifying non-volatile configuration memory (NVRAM) and adding itself to the system's `crontab`, a scheduler for running tasks. Its sole network-facing function is to locate and download the Stage 2 payload using a series of redundant and highly evasive command and control (C2) acquisition mechanisms, which I discuss below.

### Stage 2 (Core Payload & C2 Engine)
This stage is non-persistent and is removed by a device reboot. It functions as the central command hub of the operation, establishing a covert C2 channel, beaconing device information back to the attackers, and, most importantly, managing the deployment and execution of various Stage 3 modules. It is the engine that drives the malware's active operations.


### Stage 3 (Modular Plugins)
These are also non-persistent plugins that provide the framework's advanced, network-centric functionalities.1 The modular design allows the attacker to selectively deploy capabilities based on the target environment, minimizing the implant's footprint and tailoring the attack to specific objectives. This "Ã  la carte" approach enhances stealth by ensuring that only necessary tools are present on the device at any given time.

### Modular Design Optimizes OPSEC
The deliberate separation of the persistent loader (Stage 1) from the more complex and potentially "louder" operational modules (Stages 2 and 3) reveals an intimate understanding of incident response.

By making the active tools non-persistent, the attackers ensure that simple mitigation efforts, such as a device reboot, will not fully eradicate their presence. A reboot only removes the active tools, while the persistent Stage 1 implant remains dormant, ready to re-establish contact with its C2 infrastructure and re-download the subsequent stages.

This design choice forces defenders to undertake a full factory reset and firmware update to remove Stage 1 - a far more disruptive and technically challenging process for the average device owner, thereby increasing the malware's overall resilience. This architecture demonstrates that the attackers planned for discovery and built in mechanisms to withstand initial remediation efforts, reflecting a long-term strategic mindset focused on maintaining their foothold.

## Stage 1 Command & Control Acquisition Protocols
The Stage 1 implant employs a resilient, three-tiered C2 acquisition strategy designed to ensure it can download the Stage 2 payload under various network conditions and survive infrastructure takedowns.

### Primary C2 Channel: EXIF Data Steganography
The malware's first and most novel method for locating its C2 server involves steganography. The Stage 1 implant attempts to download an image from a list of public gallery pages on the legitimate, high-reputation image hosting site `photobucket.com`.

Once an image is downloaded, the malware does not use the image content itself but instead parses its EXIF metadata. Specifically, it searches for GPS information. The parser locates the "GPS Info" tag (hexadecimal`0x8825`) and extracts the integer values for latitude and longitude.

These six integer values are then algorithmically converted into an IPv4 address, which serves as the C2 server for the Stage 2 download. For instance, analysis of one such image from the domain. `toknowall.com` revealed GPS data that resolved to the known C2 IP address `217.12.202.40`.


### Secondary C2 Channel: Hardcoded Fallback Domain

If the connection to Photobucket fails or if the EXIF data cannot be successfully extracted, the malware falls back to its second C2 acquisition method. It attempts to connect to a hardcoded domain, `toknowall.com`, to download an image and perform the same EXIF-to-IP conversion process.

### Tertiary C2 Channel: Passive Network Listener

In the event that both the Photobucket and `toknowall.com` methods fail, Stage 1 activates its most resilient and stealthy mode: it becomes a passive listener, ceasing all outbound C2-seeking traffic. This makes the implant nearly impossible to detect through network monitoring alone.

First, the implant attempts to determine its own public IP address by making a DNS query to `api.ipify.org`. It then opens a raw socket and begins inspecting all incoming TCP/IPv4 packets that have the SYN flag set, which indicates the start of a new connection attempt from anywhere on the internet.

The listener waits for a specific trigger packet that contains the 4-byte magic sequence `\x0c\x15\x22\x2b`. When a packet matching these criteria is received, the malware interprets the 4 bytes immediately following the magic sequence as the IP address for the Stage 2 C2 server.

The implant then initiates a connection to this newly supplied IP address to download the next stage of the malware. This fallback mechanism shifts the burden of establishing contact from the implant to the attacker, providing an ultimate fail-safe that survives the takedown of its predefined C2 infrastructure and generates no suspicious outbound traffic.

The design of this trimodal C2 channel acquisition strategy demonstrates an exceptionally high level of operational security and fault tolerance. The attackers anticipated that their primary channels might be discovered and disrupted, as indeed eventually happened with the seizure of `toknowall.com` and the removal of the Photobucket galleries. The layers of redundancy, moving from stealthy steganography on a legitimate site to a hardcoded domain, and finally to a completely passive listener, ensured the botnet's resilience and longevity.


## Stage 2 Core C2 Channel Analysis

Once the Stage 1 loader successfully acquires a C2 address and downloads the Stage 2 payload, this core component takes over to establish a persistent, interactive command channel.

### Communication Protocols and Encryption

The Stage 2 malware is responsible for all primary C2 communications. It is capable of communicating over standard SSL/TLS and also possesses a module for routing its traffic through the Tor network for anonymization.

A critical finding in the analysis of VPNFilter was its use of a flawed implementation of the RC4 stream cipher for encrypting internal strings and some network data. Specifically, the RC4 key-scheduling algorithm contained an error where values in the permutation phase were XORed but not swapped.

This identical, non-standard flaw was previously observed in the BlackEnergy malware, which has been strongly linked to the same threat group. This operational security failure stands in stark contrast to the overall sophistication of the malware framework, suggesting that even the most advanced actors can make mistakes, or that the developers of VPNFilter were part of, or had direct access to, the BlackEnergy codebase.

### Beaconing and Command Structure

Upon execution, the Stage 2 implant creates a working environment in the `/var/run/vpnfilterw` directory and begins a recurring loop to contact its C2 server. The beacon sent to the C2 server is a JSON object containing profiling information about the compromised device.

This data is then Base64-encoded and transmitted in an HTTP POST request, typically to the URI path `/bin32/update.php` on the C2 server.

The JSON beacon allows the attacker to catalog and manage their fleet of infected devices, containing key fields such as:
- `uq`: A unique identifier, usually the device's MAC address.
- `pv`: The platform version of the device.
- `ad`: The device's public IP address.
- `bv`: The malware version for both Stage 1 and Stage 2.
- `nn`: The node name of the device.
- `tn` and `on`: Flags indicating the status and use of Tor.

The C2 server replies with its own JSON object containing instructions. Key fields in the server's response include:

- `tr`: A value to set the delay (sleep time) for the main C2 loop.
- `pxs`: An updated list of C2 proxy servers to use.
- `tor`: The name and version of the Tor module to download or use.
- `mds`: A list of Stage 3 modules to download and execute. This field specifies a command ID, the module name, and any necessary arguments, which are Base64-encoded.

### Stage 2 C2 Command Reference

The following table details the core commands that the Stage 2 malware can receive and execute. This serves as a functional dictionary for the malware's primary operations.

| Command         | Functionality                                                                                                                           | Network Implication                                                                            |
| --------------- | --------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------- |
| `download`      | Downloads a file from a specified URL to the device's local storage.                                                                    | Outbound HTTP/Tor traffic to a new, attacker-specified URL will be observed.                   |
| `copy`          | Exfiltrates a specified file from the infected device to the C2 server.                                                                 | Outbound HTTP/Tor POST request containing the file data.                                       |
| `exec`          | Executes a shell command or a downloaded Stage 3 plugin module.                                                                         | Varies based on command. Could initiate new network connections, scans, or other activities.   |
| `kill`          | Triggers the destructive payload, overwriting the first 5,000 bytes of `/dev/mtdblock0` and rebooting, rendering the device inoperable. | Device will go offline permanently. No further network traffic.                                |
| `reboot`        | Reboots the device.                                                                                                                     | Device will go offline temporarily and then reappear. Stage 1 will re-initiate C2 acquisition. |
| `delay`/`relay` | Sets the delay interval (in seconds) between C2 beaconing attempts.                                                                     | Changes the frequency of C2 beaconing traffic.                                                 |
| `seturl`        | Sets the URL for the C2 control panel.                                                                                                  | Future C2 beacons will be directed to a new URL.                                               |
| `proxy`/`port`  | Sets the IP address and port for a proxy server to be used for C2 communications.                                                       | C2 traffic will be routed through a new proxy server.                                          |
| `tor`           | Enables or disables the use of the Tor network for C2 communications.                                                                   | C2 traffic will either be sent directly (SSL) or routed through the Tor network.               |
| `stop`          | Terminates the Stage 2 malware process.                                                                                                 | All C2 beaconing will cease until the device is rebooted, which triggers Stage 1 to re-infect. |




---
[|TOC|]({{< ref "../../malware/_index.md" >}})
[|PREV|]({{< ref "sunburst.md" >}})
[|NEXT|]({{< ref "vpnfilter.md" >}})
